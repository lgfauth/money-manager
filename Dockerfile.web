# Build stage
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# Copy csproj files and restore dependencies
COPY ["src/MoneyManager.Web/MoneyManager.Web.csproj", "src/MoneyManager.Web/"]
COPY ["src/MoneyManager.Application/MoneyManager.Application.csproj", "src/MoneyManager.Application/"]
COPY ["src/MoneyManager.Domain/MoneyManager.Domain.csproj", "src/MoneyManager.Domain/"]

RUN dotnet restore "src/MoneyManager.Web/MoneyManager.Web.csproj"

# Copy everything else and build
COPY . .
WORKDIR "/src/src/MoneyManager.Web"
RUN dotnet build "MoneyManager.Web.csproj" -c Release -o /app/build

# Publish stage
FROM build AS publish
RUN dotnet publish "MoneyManager.Web.csproj" -c Release -o /app/publish /p:UseAppHost=false

# Runtime stage - Blazor WASM uses ASP.NET Core for hosting
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS final
WORKDIR /app
EXPOSE 8080
EXPOSE 8081

# Install nginx for serving static files
RUN apt-get update && apt-get install -y nginx

# Copy published files
COPY --from=publish /app/publish/wwwroot /usr/share/nginx/html

# Copy nginx config
COPY <<EOF /etc/nginx/nginx.conf
events { }
http {
    include /etc/nginx/mime.types;
    types {
        application/wasm wasm;
    }
    server {
        listen 8080;
        location / {
            root /usr/share/nginx/html;
            try_files \$uri \$uri/ /index.html =404;
            add_header Cache-Control "no-cache";
        }
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|wasm|json)$ {
            root /usr/share/nginx/html;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
EOF

CMD ["nginx", "-g", "daemon off;"]
