@using MoneyManager.Application.DTOs.Request
@using MoneyManager.Domain.Entities
@using MoneyManager.Domain.Enums
@using MoneyManager.Web.Services
@inject IAccountService AccountService
@inject ICategoryService CategoryService
@inject IRecurringTransactionService RecurringService

<div class="step-recurring">
    <h2 class="mb-4">
        <i class="fas fa-repeat text-primary"></i>
        Transações Recorrentes
    </h2>
    <p class="text-muted mb-4">
        Adicione despesas ou receitas que se repetem todo mês (aluguel, salário, assinaturas, etc.)
    </p>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }

    @if (createdRecurring.Any())
    {
        <div class="created-items mb-4">
            <h5 class="mb-3">Recorrências criadas:</h5>
            @foreach (var item in createdRecurring)
            {
                <div class="created-item">
                    <i class="fas fa-check-circle text-success"></i>
                    <strong>@item.Description</strong>
                    <span class="badge @(item.Type == TransactionType.Income ? "bg-success" : "bg-danger")">
                        @(item.Type == TransactionType.Income ? "Receita" : "Despesa")
                    </span>
                    <span class="ms-auto fw-bold">R$ @item.Amount.ToString("N2")</span>
                </div>
            }
        </div>
    }

    <div class="card bg-light p-4 mb-4">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Descrição</label>
                <input type="text" class="form-control" @bind="newRecurring.Description" placeholder="Ex: Aluguel, Netflix, Salário" />
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Tipo</label>
                <select class="form-select" @bind="transactionType">
                    <option value="Expense">Despesa</option>
                    <option value="Income">Receita</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Valor</label>
                <MoneyInput @bind-Value="newRecurring.Amount" Placeholder="0,00" />
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Conta</label>
                <select class="form-select" @bind="newRecurring.AccountId">
                    <option value="">Selecione</option>
                    @foreach (var account in accounts)
                    {
                        <option value="@account.Id">@account.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Categoria</label>
                <select class="form-select" @bind="newRecurring.CategoryId">
                    <option value="">Selecione</option>
                    @foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Frequência</label>
                <select class="form-select" @bind="frequencyType">
                    <option value="3">Mensal</option>
                    <option value="1">Semanal</option>
                    <option value="4">Trimestral</option>
                    <option value="6">Anual</option>
                </select>
            </div>
            <div class="col-12">
                <button class="btn btn-primary" @onclick="AddRecurring" disabled="@isCreating">
                    <i class="fas @(isCreating ? "fa-spinner fa-spin" : "fa-plus")"></i>
                    Adicionar Recorrência
                </button>
            </div>
        </div>
    </div>

    <div class="suggestions mb-4">
        <h6 class="text-muted mb-3">
            <i class="fas fa-lightbulb"></i> Exemplos comuns:
        </h6>
        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => QuickAddRecurring(\"Aluguel\", TransactionType.Expense, 0)">
                <i class="fas fa-home"></i> Aluguel
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => QuickAddRecurring(\"Salário\", TransactionType.Income, 0)">
                <i class="fas fa-money-bill-wave"></i> Salário
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => QuickAddRecurring(\"Internet\", TransactionType.Expense, 0)">
                <i class="fas fa-wifi"></i> Internet
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => QuickAddRecurring(\"Netflix\", TransactionType.Expense, 0)">
                <i class="fas fa-tv"></i> Netflix
            </button>
        </div>
    </div>

    <div class="action-buttons d-flex justify-content-between">
        <button class="btn btn-outline-secondary" @onclick="OnBack">
            <i class="fas fa-arrow-left"></i> Voltar
        </button>
        <div>
            <button class="btn btn-outline-secondary me-2" @onclick="OnSkip">
                Pular
            </button>
            <button class="btn btn-primary btn-lg" @onclick="HandleNext">
                Próximo <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnNext { get; set; }
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public EventCallback OnSkip { get; set; }

    private CreateRecurringTransactionRequestDto newRecurring = new() 
    { 
        StartDate = DateTime.Today,
        Frequency = RecurrenceFrequency.Monthly
    };
    private string transactionType = "Expense";
    private string frequencyType = "3";
    private List<Account> accounts = new();
    private List<Category> categories = new();
    private List<CreateRecurringTransactionRequestDto> createdRecurring = new();
    private bool isCreating = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var accountsData = await AccountService.GetAllAsync();
            accounts = accountsData.ToList();

            var categoriesData = await CategoryService.GetAllAsync();
            categories = categoriesData.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao carregar dados: {ex.Message}";
        }
    }

    private async Task AddRecurring()
    {
        if (string.IsNullOrWhiteSpace(newRecurring.Description))
        {
            errorMessage = "Por favor, informe a descrição";
            return;
        }

        if (string.IsNullOrWhiteSpace(newRecurring.AccountId))
        {
            errorMessage = "Por favor, selecione uma conta";
            return;
        }

        isCreating = true;
        errorMessage = null;

        try
        {
            newRecurring.Type = transactionType == "Income" ? TransactionType.Income : TransactionType.Expense;
            newRecurring.Frequency = (RecurrenceFrequency)int.Parse(frequencyType);
            
            await RecurringService.CreateAsync(newRecurring);
            
            createdRecurring.Add(new CreateRecurringTransactionRequestDto 
            { 
                Description = newRecurring.Description,
                Type = newRecurring.Type,
                Amount = newRecurring.Amount
            });
            
            // Reset form
            newRecurring = new CreateRecurringTransactionRequestDto 
            { 
                StartDate = DateTime.Today,
                Frequency = RecurrenceFrequency.Monthly
            };
            transactionType = "Expense";
            frequencyType = "3";
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao criar recorrência: {ex.Message}";
        }
        finally
        {
            isCreating = false;
        }
    }

    private void QuickAddRecurring(string description, TransactionType type, decimal amount)
    {
        newRecurring.Description = description;
        newRecurring.Amount = amount;
        transactionType = type.ToString();
    }

    private async Task HandleNext()
    {
        await OnNext.InvokeAsync();
    }
}
