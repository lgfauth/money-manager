@using MoneyManager.Application.DTOs.Request
@using MoneyManager.Domain.Enums
@using MoneyManager.Web.Services
@inject IAccountService AccountService

<div class="step-accounts">
    <h2 class="mb-4">
        <i class="fas fa-wallet text-primary"></i>
        Suas Contas
    </h2>
    <p class="text-muted mb-4">
        Adicione as contas que você usará no dia a dia (conta corrente, poupança, carteiras digitais, etc.)
    </p>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }

    @if (createdAccounts.Any())
    {
        <div class="created-items mb-4">
            <h5 class="mb-3">Contas criadas:</h5>
            @foreach (var account in createdAccounts)
            {
                <div class="created-item">
                    <i class="fas fa-check-circle text-success"></i>
                    <strong>@account.Name</strong>
                    <span class="text-muted">- @GetAccountTypeLabel(account.Type)</span>
                    <span class="ms-auto fw-bold">R$ @account.InitialBalance.ToString("N2")</span>
                </div>
            }
        </div>
    }

    <div class="account-form card bg-light p-4 mb-4">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Nome da Conta</label>
                <input type="text" class="form-control" @bind="newAccount.Name" placeholder="Ex: Conta Corrente Itaú" />
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Tipo</label>
                <select class="form-select" @bind="selectedAccountType">
                    <option value="0">Conta Corrente</option>
                    <option value="1">Poupança</option>
                    <option value="2">Dinheiro</option>
                    <option value="3">Cartão de Crédito</option>
                    <option value="4">Investimento</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Saldo Inicial</label>
                <MoneyInput @bind-Value="newAccount.InitialBalance" Placeholder="0,00" />
            </div>
            <div class="col-12">
                <button class="btn btn-primary" @onclick="AddAccount" disabled="@isCreating">
                    <i class="fas @(isCreating ? "fa-spinner fa-spin" : "fa-plus")"></i>
                    @(isCreating ? "Adicionando..." : "Adicionar Conta")
                </button>
            </div>
        </div>
    </div>

    <div class="suggestions mb-4">
        <h6 class="text-muted mb-3">
            <i class="fas fa-lightbulb"></i> Sugestões:
        </h6>
        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => QuickAddAccount(\"Conta Corrente\", AccountType.Checking, 0)">
                <i class="fas fa-university"></i> Conta Corrente
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => QuickAddAccount(\"Poupança\", AccountType.Savings, 0)">
                <i class="fas fa-piggy-bank"></i> Poupança
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => QuickAddAccount(\"Carteira\", AccountType.Cash, 0)">
                <i class="fas fa-wallet"></i> Carteira
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => QuickAddAccount(\"Cartão de Crédito\", AccountType.CreditCard, 0)">
                <i class="fas fa-credit-card"></i> Cartão de Crédito
            </button>
        </div>
    </div>

    <div class="action-buttons d-flex justify-content-between">
        <button class="btn btn-outline-secondary" @onclick="OnSkip">
            Pular esta etapa
        </button>
        <button class="btn btn-primary btn-lg" @onclick="HandleNext" disabled="@(!createdAccounts.Any())">
            Próximo <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

<style>
    .created-items {
        max-height: 200px;
        overflow-y: auto;
    }

    .created-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 8px;
    }
</style>

@code {
    [Parameter] public EventCallback OnNext { get; set; }
    [Parameter] public EventCallback OnSkip { get; set; }

    private CreateAccountRequestDto newAccount = new();
    private string selectedAccountType = "0";
    private List<CreateAccountRequestDto> createdAccounts = new();
    private bool isCreating = false;
    private string? errorMessage;

    private async Task AddAccount()
    {
        if (string.IsNullOrWhiteSpace(newAccount.Name))
        {
            errorMessage = "Por favor, informe o nome da conta";
            return;
        }

        isCreating = true;
        errorMessage = null;

        try
        {
            newAccount.Type = (AccountType)int.Parse(selectedAccountType);
            await AccountService.CreateAsync(newAccount);
            
            createdAccounts.Add(new CreateAccountRequestDto 
            { 
                Name = newAccount.Name, 
                Type = newAccount.Type, 
                InitialBalance = newAccount.InitialBalance 
            });
            
            // Reset form
            newAccount = new CreateAccountRequestDto();
            selectedAccountType = "0";
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao criar conta: {ex.Message}";
        }
        finally
        {
            isCreating = false;
        }
    }

    private async Task QuickAddAccount(string name, AccountType type, decimal balance)
    {
        newAccount.Name = name;
        newAccount.Type = type;
        newAccount.InitialBalance = balance;
        selectedAccountType = ((int)type).ToString();
        await AddAccount();
    }

    private async Task HandleNext()
    {
        await OnNext.InvokeAsync();
    }

    private string GetAccountTypeLabel(AccountType type)
    {
        return type switch
        {
            AccountType.Checking => "Conta Corrente",
            AccountType.Savings => "Poupança",
            AccountType.Cash => "Dinheiro",
            AccountType.CreditCard => "Cartão de Crédito",
            AccountType.Investment => "Investimento",
            _ => "Outro"
        };
    }
}
