@using MoneyManager.Application.DTOs.Request
@using MoneyManager.Application.DTOs.Response

@* Modal para ajustar o preço de mercado de um ativo *@

@if (IsVisible && SelectedAsset != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line"></i> Ajustar Preço de Mercado
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Cancel" disabled="@isBusy"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible">
                            <i class="fas fa-exclamation-triangle"></i> @errorMessage
                            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
                        </div>
                    }

                    <!-- Informações do Ativo -->
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="mb-2">
                                <AssetTypeIcon AssetType="@SelectedAsset.AssetType" />
                                <strong class="ms-2">@SelectedAsset.Name</strong>
                                @if (!string.IsNullOrEmpty(SelectedAsset.Ticker))
                                {
                                    <span class="text-muted">(@SelectedAsset.Ticker)</span>
                                }
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted d-block">Quantidade</small>
                                    <strong>@SelectedAsset.Quantity.ToString("N2")</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Preço Médio</small>
                                    <strong>R$ @SelectedAsset.AveragePurchasePrice.ToString("N2")</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <!-- Preço Atual -->
                        <div class="col-md-6">
                            <label class="form-label">Preço Atual</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control" value="@SelectedAsset.CurrentPrice.ToString("N2")" disabled />
                            </div>
                            @if (SelectedAsset.LastPriceUpdate.HasValue)
                            {
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> Atualizado em @SelectedAsset.LastPriceUpdate.Value.ToString("dd/MM/yyyy HH:mm")
                                </small>
                            }
                        </div>

                        <!-- Novo Preço -->
                        <div class="col-md-6">
                            <label class="form-label">Novo Preço <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" @bind="request.NewPrice" step="0.01" min="0.01" placeholder="0,00" />
                            </div>
                        </div>

                        <!-- Data de Referência -->
                        <div class="col-md-6">
                            <label class="form-label">Data de Referência</label>
                            <input type="date" class="form-control" @bind="request.Date" />
                        </div>
                    </div>

                    <!-- Cálculos em Tempo Real -->
                    @if (request.NewPrice > 0)
                    {
                        var variation = request.NewPrice - SelectedAsset.CurrentPrice;
                        var variationPercentage = SelectedAsset.CurrentPrice > 0 
                            ? (variation / SelectedAsset.CurrentPrice) * 100 
                            : 0;
                        var newTotalValue = SelectedAsset.Quantity * request.NewPrice;
                        var newProfitLoss = newTotalValue - SelectedAsset.TotalInvested;

                        <div class="card mt-3 @(variation >= 0 ? "border-success" : "border-danger")">
                            <div class="card-header @(variation >= 0 ? "bg-success" : "bg-danger") text-white py-2">
                                <small><i class="fas fa-calculator"></i> Simulação do Ajuste</small>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Variação Absoluta</small>
                                        <h6 class="mb-0 @(variation >= 0 ? "text-success" : "text-danger")">
                                            <i class="fas fa-arrow-@(variation >= 0 ? "up" : "down")"></i>
                                            R$ @Math.Abs(variation).ToString("N2")
                                        </h6>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Variação Percentual</small>
                                        <h6 class="mb-0 @(variationPercentage >= 0 ? "text-success" : "text-danger")">
                                            @variationPercentage.ToString("N2")%
                                        </h6>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Novo Valor Total</small>
                                        <h6 class="mb-0">R$ @newTotalValue.ToString("N2")</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Novo Lucro/Prejuízo</small>
                                        <h6 class="mb-0 @(newProfitLoss >= 0 ? "text-success" : "text-danger")">
                                            R$ @newProfitLoss.ToString("N2")
                                        </h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Cancel" disabled="@isBusy">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-info" @onclick="ConfirmAdjust" disabled="@isBusy">
                        @if (isBusy)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        else
                        {
                            <i class="fas fa-check"></i>
                        }
                        Ajustar Preço
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public InvestmentAssetResponseDto? SelectedAsset { get; set; }

    [Parameter]
    public EventCallback OnSuccess { get; set; }

    private AdjustPriceRequestDto request = new();
    private bool isBusy = false;
    private string? errorMessage;

    protected override void OnParametersSet()
    {
        if (IsVisible && SelectedAsset != null)
        {
            request = new AdjustPriceRequestDto
            {
                NewPrice = SelectedAsset.CurrentPrice,
                Date = DateTime.Today
            };
            errorMessage = null;
        }
    }

    private async Task ConfirmAdjust()
    {
        if (isBusy || SelectedAsset == null) return;

        errorMessage = null;

        // Validações
        if (request.NewPrice <= 0)
        {
            errorMessage = "O novo preço deve ser maior que zero.";
            return;
        }

        if (request.NewPrice == SelectedAsset.CurrentPrice)
        {
            errorMessage = "O novo preço deve ser diferente do preço atual.";
            return;
        }

        isBusy = true;

        try
        {
            await OnSuccess.InvokeAsync();
            await CloseModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro: {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task Cancel()
    {
        if (isBusy) return;
        await CloseModal();
    }

    private async Task CloseModal()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(IsVisible);
        errorMessage = null;
    }

    public AdjustPriceRequestDto GetRequest() => request;
}
