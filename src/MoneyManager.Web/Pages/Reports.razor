@page "/reports"
@using MoneyManager.Web.Services.Localization
@using MoneyManager.Web.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@attribute [Authorize]
@inject IReportService ReportService
@inject ILocalizationService Localization
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Relatórios - MoneyManager</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0">
                <i class="fas fa-chart-pie text-primary"></i> Relatórios Financeiros
            </h1>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3 text-muted">Carregando relatórios...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }
    else
    {
        <!-- Filtro de Período -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-12 col-md-4">
                                <label class="form-label">Período</label>
                                <select class="form-select" @bind="PeriodPreset">
                                    <option value="current_month">Mês atual</option>
                                    <option value="last_month">Mês anterior</option>
                                    <option value="last_3_months">Ãšltimos 3 meses</option>
                                    <option value="last_6_months">Ãšltimos 6 meses</option>
                                    <option value="last_year">Ãšltimo ano</option>
                                    <option value="custom">@Localization.Get("Reports.Custom")</option>
                                </select>
                            </div>

                            <div class="col-6 col-md-3">
                                <label class="form-label">@Localization.Get("Reports.From")</label>
                                <input type="date" class="form-control" @bind="filterStart" disabled="@(periodPreset != "custom")" />
                            </div>

                            <div class="col-6 col-md-3">
                                <label class="form-label">Até</label>
                                <input type="date" class="form-control" @bind="filterEnd" disabled="@(periodPreset != "custom")" />
                            </div>

                            <div class="col-12 col-md-2 d-grid">
                                <button class="btn btn-primary" @onclick="ApplyPeriodFilter">
                                    Aplicar
                                </button>
                            </div>

                            @if (periodPreset != "custom")
                            {
                                <div class="col-12">
                                    <small class="text-muted">
                                        @Localization.Get("Reports.Viewing") <strong>@filterStart.ToString("dd/MM/yyyy")</strong> até <strong>@filterEnd.ToString("dd/MM/yyyy")</strong>
                                    </small>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-12 col-md-6 col-lg-3">
                <div class="stat-card success">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-value text-success">R$ @reportSummary.TotalIncome.ToString("N2")</div>
                            <div class="stat-label">@Localization.Get("Reports.TotalIncome") (@GetPeriodLabel())</div>
                        </div>
                        <i class="fas fa-arrow-up fa-3x text-muted opacity-50"></i>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <div class="stat-card danger">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-value text-danger">R$ @reportSummary.TotalExpenses.ToString("N2")</div>
                            <div class="stat-label">@Localization.Get("Reports.TotalExpenses") (@GetPeriodLabel())</div>
                        </div>
                        <i class="fas fa-arrow-down fa-3x text-muted opacity-50"></i>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <div class="stat-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-value text-primary">R$ @reportSummary.NetBalance.ToString("N2")</div>
                            <div class="stat-label">Saldo Líquido</div>
                        </div>
                        <i class="fas fa-chart-line fa-3x text-muted opacity-50"></i>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <div class="stat-card @(reportSummary.SavingsRate >= 20 ? "success" : reportSummary.SavingsRate >= 10 ? "warning" : "danger")">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-value @(reportSummary.SavingsRate >= 20 ? "text-success" : reportSummary.SavingsRate >= 10 ? "text-warning" : "text-danger")">
                                @reportSummary.SavingsRate.ToString("N1")%
                            </div>
                            <div class="stat-label">@Localization.Get("Reports.SavingsRate")</div>
                        </div>
                        <i class="fas fa-piggy-bank fa-3x text-muted opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <!-- GrÃ¡fico de Pizza - @Localization.Get("Reports.ExpensesByCategory") -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> @Localization.Get("Reports.ExpensesByCategory")</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="expensesByCategoryChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- GrÃ¡fico de Linhas - Evoluçãoo Mensal -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Evoluçãoo Mensal</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="monthlyTrendChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalhamento de @Localization.Get("Reports.ExpensesByCategory") (Cards) -->
        <div class="row g-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Detalhamento de @Localization.Get("Reports.ExpensesByCategory")</h5>
                    </div>
                    <div class="card-body">
                        @if (reportSummary.ExpensesByCategory.Any())
                        {
                            <div class="row g-3">
                                @foreach (var expense in reportSummary.ExpensesByCategory)
                                {
                                    <div class="col-12 col-md-6 col-lg-4">
                                        <div class="card h-100 border-0 shadow-sm">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between gap-2">
                                                    <div class="min-w-0">
                                                        <div class="fw-semibold text-truncate" title="@expense.CategoryName">@expense.CategoryName</div>
                                                        <small class="text-muted">@expense.Percentage.ToString("N1")% @Localization.Get("Reports.OfTotal")</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="fw-bold">R$ @expense.Amount.ToString("N2")</div>
                                                    </div>
                                                </div>

                                                <div class="progress mt-3" style="height: 8px;">
                                                    <div class="progress-bar"
                                                         role="progressbar"
                                                         style="width: @expense.Percentage.ToString("N1")%"
                                                         aria-valuenow="@expense.Percentage"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Nenhuma despesa registrada no período</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private ReportSummary reportSummary = new();
    private bool chartsRendered = false;

    private string periodPreset = "current_month";
    private DateTime filterStart = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime filterEnd = new(DateTime.Today.Year, DateTime.Today.Month, DateTime.DaysInMonth(DateTime.Today.Year, DateTime.Today.Month));

    private string PeriodPreset
    {
        get => periodPreset;
        set
        {
            if (periodPreset == value) return;

            periodPreset = value;
            if (periodPreset != "custom")
            {
                ApplyPresetToDates();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        ApplyPresetToDates();
        await LoadReports();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading && !chartsRendered && reportSummary != null)
        {
            chartsRendered = true;
            await RenderCharts();
        }
    }

    private void ApplyPresetToDates()
    {
        var today = DateTime.Today;

        switch (periodPreset)
        {
            case "current_month":
                filterStart = new DateTime(today.Year, today.Month, 1);
                filterEnd = new DateTime(today.Year, today.Month, DateTime.DaysInMonth(today.Year, today.Month));
                break;

            case "last_month":
                var lastMonth = today.AddMonths(-1);
                filterStart = new DateTime(lastMonth.Year, lastMonth.Month, 1);
                filterEnd = new DateTime(lastMonth.Year, lastMonth.Month, DateTime.DaysInMonth(lastMonth.Year, lastMonth.Month));
                break;

            case "last_3_months":
                filterEnd = today;
                filterStart = today.AddMonths(-3);
                break;

            case "last_6_months":
                filterEnd = today;
                filterStart = today.AddMonths(-6);
                break;

            case "last_year":
                filterEnd = today;
                filterStart = today.AddYears(-1);
                break;

            case "custom":
            default:
                // leave as is
                break;
        }
    }

    private async Task ApplyPeriodFilter()
    {
        chartsRendered = false;
        await LoadReports();
        StateHasChanged();
    }

    private async Task LoadReports()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            reportSummary = await ReportService.GetReportSummaryAsync(filterStart, filterEnd);
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao carregar relatórios: {ex.Message}";
            Console.WriteLine($"Erro: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RenderCharts()
    {
        try
        {
            await Task.Delay(100);

            await RenderExpensesByCategoryChart();
            await RenderMonthlyTrendChart();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao renderizar grÃ¡ficos: {ex.Message}");
        }
    }

    private async Task RenderExpensesByCategoryChart()
    {
        try
        {
            if (!reportSummary.ExpensesByCategory.Any())
            {
                var labels = new[] { "Sem despesas" };
                var data = new[] { 1.0 };
                var colors = new[] { "rgba(200, 200, 200, 0.7)" };
                await JSRuntime.InvokeVoidAsync("chartInterop.createPieChart", "expensesByCategoryChart", labels, data, colors);
                return;
            }

            var chartLabels = reportSummary.ExpensesByCategory.Select(e => e.CategoryName).ToArray();
            var chartData = reportSummary.ExpensesByCategory.Select(e => (double)e.Amount).ToArray();
            var chartColors = reportSummary.ExpensesByCategory.Select((_, i) => GetChartColor(i)).ToArray();

            await JSRuntime.InvokeVoidAsync("chartInterop.createPieChart", "expensesByCategoryChart", chartLabels, chartData, chartColors);
            Console.WriteLine("Expenses by category chart renderizado com sucesso");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao renderizar expenses by category chart: {ex.Message}");
        }
    }

    private async Task RenderMonthlyTrendChart()
    {
        try
        {
            if (!reportSummary.MonthlyTrends.Any())
            {
                return;
            }

            var labels = reportSummary.MonthlyTrends.Select(t => t.Month).ToArray();
            var incomeData = reportSummary.MonthlyTrends.Select(t => (double)t.Income).ToArray();
            var expensesData = reportSummary.MonthlyTrends.Select(t => (double)t.Expenses).ToArray();

            await JSRuntime.InvokeVoidAsync(
                "chartInterop.createLineChart",
                "monthlyTrendChart",
                labels,
                new { income = incomeData, expenses = expensesData });

            Console.WriteLine("Monthly trend chart renderizado com sucesso");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao renderizar monthly trend chart: {ex.Message}");
        }
    }

    private string GetChartColor(int index)
    {
        var colors = new[]
        {
            "rgba(102, 126, 234, 0.7)",
            "rgba(118, 75, 162, 0.7)",
            "rgba(255, 107, 107, 0.7)",
            "rgba(78, 205, 196, 0.7)",
            "rgba(255, 159, 64, 0.7)",
            "rgba(153, 102, 255, 0.7)",
            "rgba(255, 205, 86, 0.7)",
            "rgba(75, 192, 192, 0.7)",
            "rgba(255, 99, 132, 0.7)",
            "rgba(54, 162, 235, 0.7)"
        };
        return colors[index % colors.Length];
    }

    private string GetPeriodLabel()
    {
        if (periodPreset == "custom")
        {
            return "personalizado";
        }

        return periodPreset switch
        {
            "current_month" => "mês atual",
            "last_month" => "mês anterior",
            "last_3_months" => "3 meses",
            "last_6_months" => "6 meses",
            "last_year" => "1 ano",
            _ => "período"
        };
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("chartInterop.destroyAllCharts");
        }
        catch
        {
            // ignore
        }
    }
}

