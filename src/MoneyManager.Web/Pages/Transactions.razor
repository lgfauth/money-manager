@page "/transactions"
@using MoneyManager.Domain.Entities
@using MoneyManager.Domain.Enums
@using MoneyManager.Web.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@attribute [Authorize]
@inject ITransactionService TransactionService
@inject IRecurringTransactionService RecurringTransactionService
@inject IAccountService AccountService
@inject ICategoryService CategoryService
@inject IJSRuntime JSRuntime

<PageTitle>TransaÃ§Ãµes - MoneyManager</PageTitle>

<BusyOverlay IsBusy="@isBusy" Message="Processando..." />

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-exchange-alt text-primary"></i> TransaÃ§Ãµes
                </h1>
                <button class="btn btn-primary" @onclick="ShowAddModal">
                    <i class="fas fa-plus"></i> Nova TransaÃ§Ã£o
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12 col-md-4">
            <label class="form-label">Ordenar por</label>
            <select class="form-select" @bind="transactionsSort">
                <option value="date_desc">Data (mais recente)</option>
                <option value="date_asc">Data (mais antiga)</option>
                <option value="category">Categoria</option>
                <option value="amount_desc">Valor (maior)</option>
                <option value="amount_asc">Valor (menor)</option>
            </select>
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">PerÃ­odo</label>
            <select class="form-select" @bind="PeriodPreset">
                <option value="current_month">MÃªs atual</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>

        <div class="col-6 col-md-2">
            <label class="form-label">De</label>
            <input type="date" class="form-control" @bind="filterStart" disabled="@(periodPreset != "custom")" />
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label">AtÃ©</label>
            <input type="date" class="form-control" @bind="filterEnd" disabled="@(periodPreset != "custom")" />
        </div>

        <div class="col-12 col-md-4 mt-3 mt-md-0">
            <label class="form-label">Mostrar</label>
            <select class="form-select" @bind="transactionTypeFilter">
                <option value="all">Entradas e SaÃ­das</option>
                <option value="income">Somente Entradas</option>
                <option value="expense">Somente SaÃ­das</option>
            </select>
        </div>
    </div>

    @if (showAdd)
    {
        <div class="card mb-4">
            <div class="card-body">
                <h5>Nova TransaÃ§Ã£o</h5>
                @if (!string.IsNullOrEmpty(addError))
                {
                    <div class="alert alert-danger">@addError</div>
                }
                <div class="row g-2">
                    <div class="col-md-2">
                        <input type="date" class="form-control" @bind="newTransaction.Date" />
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" @bind="newRequest.AccountId">
                            <option value="">-- Conta --</option>
                            @foreach (var a in GetAccountsOrdered(accountsList))
                            {
                                <option value="@a.Id">@a.Name (@GetAccountTypeLabel(a.Type))</option>
                            }
                        </select>
                    </div>
                    @if (newRequest.Type == 2)
                    {
                        <div class="col-md-3">
                            <select class="form-select" @bind="newRequest.ToAccountId">
                                <option value="">-- Conta destino --</option>
                                @foreach (var a in GetAccountsOrdered(accountsList))
                                {
                                    if (a.Id != newRequest.AccountId)
                                    {
                                        <option value="@a.Id">@a.Name (@GetAccountTypeLabel(a.Type))</option>
                                    }
                                }
                            </select>
                        </div>
                    }
                    <div class="col-md-3">
                        <input class="form-control" placeholder="DescriÃ§Ã£o" @bind="newRequest.Description" />
                    </div>
                    <div class="col-md-2">
                        <MoneyInput @bind-Value="newRequest.Amount" Placeholder="Valor" />
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" @bind="newRequest.Type">
                            <option value="0">Receita</option>
                            <option value="1">Despesa</option>
                            <option value="2">TransferÃªncia</option>
                        </select>
                    </div>

                    @if (IsSelectedAccountCreditCard() && newRequest.Type == 1)
                    {
                        <div class="col-12">
                            <div class="alert alert-secondary py-2 mb-0">
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <div>
                                        <label class="form-label mb-0">Parcelamento</label>
                                        <select class="form-select" style="min-width: 110px" @bind="installmentsCount">
                                            @for (var i = 1; i <= 12; i++)
                                            {
                                                <option value="@i">@i x</option>
                                            }
                                        </select>
                                    </div>

                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="firstInCurrent" @bind="firstInstallmentInCurrentInvoice" />
                                        <label class="form-check-label" for="firstInCurrent">
                                            Primeira parcela entra na fatura atual
                                        </label>
                                    </div>
                                </div>
                                @if (installmentsCount > 1)
                                {
                                    <small class="text-muted d-block mt-2">
                                        O valor informado Ã© o total. O sistema lanÃ§arÃ¡ a 1Âª parcela agora (se marcado) e criarÃ¡ uma recorrÃªncia mensal para as demais.
                                    </small>
                                }
                            </div>
                        </div>
                    }

                    @if (newRequest.Type != 2)
                    {
                        <div class="col-md-3">
                            <select class="form-select" @bind="newRequest.CategoryId">
                                <option value="">-- Categoria --</option>
                                @if (categoriesList != null)
                                {
                                    @foreach (var c in categoriesList)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                }
                            </select>
                        </div>
                    }
                    <div class="col-md-2 d-grid">
                        <button class="btn btn-success" @onclick="CreateTransaction">Salvar</button>
                        <button class="btn btn-link text-danger" @onclick="CancelAdd">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3 text-muted">Carregando transaÃ§Ãµes...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }
    else if (transactions != null && transactions.Any())
    {
        var viewTransactions = GetTransactionsSorted(ApplyFilters(transactions));
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th><i class="fas fa-calendar"></i> Data</th>
                            <th><i class="fas fa-file-alt"></i> DescriÃ§Ã£o</th>
                            <th><i class="fas fa-tag"></i> Categoria</th>
                            <th class="text-end"><i class="fas fa-money-bill"></i> Valor</th>
                            <th class="text-center">AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var transaction in viewTransactions)
                        {
                            <tr>
                                <td>@transaction.Date.ToString("dd/MM/yyyy")</td>
                                <td>@transaction.Description</td>
                                <td>
                                    <span class="badge bg-light text-dark">@GetCategoryName(transaction.CategoryId)</span>
                                </td>
                                <td class="text-end fw-bold">
                                    @if (transaction.Type.ToString() == "Income")
                                    {
                                        <span class="text-success">+ R$ @transaction.Amount.ToString("F2")</span>
                                    }
                                    else if (transaction.Type.ToString() == "Transfer")
                                    {
                                        <span class="text-primary">R$ @transaction.Amount.ToString("F2")</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger">- R$ @transaction.Amount.ToString("F2")</span>
                                    }
                                </td>
                                <td class="text-center">
                                <button class="btn btn-sm btn-warning me-2" @onclick="() => BeginEditTransaction(transaction.Id)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteTransaction(transaction.Id)" disabled="@isBusy">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle"></i> Nenhuma transaÃ§Ã£o encontrada. <a href="#" @onclick="ShowAddModal">Clique aqui para criar uma.</a>
        </div>
    }
</div>

@code {
    private IEnumerable<Transaction>? transactions;
    private bool isLoading = true;
    private string? errorMessage;
    private IEnumerable<Account>? accountsList;
    private IEnumerable<Category>? categoriesList;
    private Dictionary<string, string> categoriesDict = new();

    private string transactionsSort = "date_desc";

    private string periodPreset = "current_month";
    private string transactionTypeFilter = "all";
    private DateTime filterStart = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime filterEnd = new(DateTime.Today.Year, DateTime.Today.Month, DateTime.DaysInMonth(DateTime.Today.Year, DateTime.Today.Month));

    private string PeriodPreset
    {
        get => periodPreset;
        set
        {
            if (periodPreset == value) return;

            periodPreset = value;
            if (periodPreset == "current_month")
            {
                ResetFilterToCurrentMonth();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        ResetFilterToCurrentMonth();
        await LoadTransactions();
        accountsList = await AccountService.GetAllAsync();
        categoriesList = await CategoryService.GetAllAsync();
        categoriesDict = categoriesList?.ToDictionary(c => c.Id, c => c.Name) ?? new Dictionary<string, string>();
    }

    private void ResetFilterToCurrentMonth()
    {
        var today = DateTime.Today;
        filterStart = new DateTime(today.Year, today.Month, 1);
        filterEnd = new DateTime(today.Year, today.Month, DateTime.DaysInMonth(today.Year, today.Month));
    }

    private async Task LoadTransactions()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            transactions = await TransactionService.GetAllAsync();
            if (transactions == null || !transactions.Any())
            {
                errorMessage = "Nenhuma transaÃ§Ã£o disponÃ­vel.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao carregar transaÃ§Ãµes: {ex.Message}";
            Console.WriteLine($"Erro: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowAddModal()
    {
        showAdd = true;
    }

    private bool showAdd;
    private Transaction newTransaction = new Transaction { Date = DateTime.Today };
    private string? addError;
    private CreateTransactionRequestDto newRequest = new CreateTransactionRequestDto { Date = DateTime.Today, Type = (int)TransactionType.Expense };
    private string? editingTransactionId;
    private bool isBusy;

    private async Task BeginEditTransaction(string id)
    {
        try
        {
            var tx = await TransactionService.GetByIdAsync(id);
            if (tx != null)
            {
                // populate request DTO from existing transaction
                newRequest = new CreateTransactionRequestDto
                {
                    AccountId = tx.AccountId,
                    Amount = tx.Amount,
                    CategoryId = tx.CategoryId,
                    Date = tx.Date,
                    Description = tx.Description,
                    Status = (int)tx.Status,
                    Tags = tx.Tags ?? new List<string>(),
                    ToAccountId = tx.ToAccountId,
                    Type = (int)tx.Type
                };

                editingTransactionId = id;
                showAdd = true;
            }
        }
        catch (Exception ex)
        {
            addError = ex.Message;
        }
    }

    private async Task CreateTransaction()
    {
        addError = null;
        if (isBusy) return;
        isBusy = true;
        try
        {
            if (string.IsNullOrEmpty(newRequest.AccountId))
            {
                addError = "Selecione uma conta";
                return;
            }

            if (newRequest.Type == 2)
            {
                if (string.IsNullOrEmpty(newRequest.ToAccountId))
                {
                    addError = "Selecione a conta destino";
                    return;
                }

                if (newRequest.ToAccountId == newRequest.AccountId)
                {
                    addError = "A conta destino deve ser diferente da conta origem";
                    return;
                }

                // Categoria nÃ£o se aplica a TransferÃªncias
                newRequest.CategoryId = null;
            }

            if (!string.IsNullOrEmpty(editingTransactionId))
            {
                await TransactionService.UpdateAsync(editingTransactionId, newRequest);
            }
            else
            {
                // Purchase installment flow (credit card expense)
                if (ShouldCreateInstallments())
                {
                    var confirmed = await ConfirmInstallmentStartAsync();
                    if (!confirmed)
                    {
                        return;
                    }

                    await CreateInstallmentPurchaseAsync(newRequest);
                }
                else
                {
                    await TransactionService.CreateAsync(newRequest);
                }
            }

            newRequest = new CreateTransactionRequestDto { Date = DateTime.Today, Type = (int)TransactionType.Expense };
            showAdd = false;
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            addError = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }

    private void CancelAdd()
    {
        if (isBusy) return;
        showAdd = false;
        newTransaction = new Transaction { Date = DateTime.Today };
        addError = null;
    }

    private async Task DeleteTransaction(string id)
    {
        if (isBusy) return;
        isBusy = true;
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Tem certeza que deseja deletar esta transaÃ§Ã£o?");
            if (!confirmed)
                return;

            await TransactionService.DeleteAsync(id);
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao deletar transaÃ§Ã£o: {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private string GetCategoryName(string? categoryId)
    {
        if (string.IsNullOrEmpty(categoryId))
            return "Sem categoria";

        return categoriesDict.TryGetValue(categoryId, out var name) ? name : "Categoria desconhecida";
    }

    private IEnumerable<Transaction> GetTransactionsSorted(IEnumerable<Transaction> list)
    {
        return transactionsSort switch
        {
            "date_asc" => list.OrderBy(t => t.Date),
            "category" => list.OrderBy(t => GetCategoryName(t.CategoryId)).ThenByDescending(t => t.Date),
            "amount_asc" => list.OrderBy(t => t.Amount),
            "amount_desc" => list.OrderByDescending(t => t.Amount),
            _ => list.OrderByDescending(t => t.Date)
        };
    }

    private IEnumerable<Transaction> ApplyFilters(IEnumerable<Transaction> list)
    {
        var start = filterStart.Date;
        var end = filterEnd.Date;
        if (end < start)
        {
            (start, end) = (end, start);
        }

        var query = list.Where(t => t.Date.Date >= start && t.Date.Date <= end);

        // Separar corretamente transaÃ§Ãµes de despesa das de receita.
        // TransferÃªncias nÃ£o entram em entradas/saÃ­das.
        query = transactionTypeFilter switch
        {
            "income" => query.Where(t => t.Type == TransactionType.Income),
            "expense" => query.Where(t => t.Type == TransactionType.Expense),
            _ => query
        };

        return query;
    }

    private static IEnumerable<Account> GetAccountsOrdered(IEnumerable<Account>? accounts)
    {
        if (accounts is null) return Enumerable.Empty<Account>();

        return accounts
            .OrderBy(a => GetAccountTypeSortKey(a.Type))
            .ThenBy(a => a.Name);
    }

    private static int GetAccountTypeSortKey(AccountType type)
    {
        return type switch
        {
            AccountType.Cash => 0,
            AccountType.Checking => 1,
            AccountType.Savings => 2,
            AccountType.CreditCard => 3,
            AccountType.Investment => 4,
            _ => 99
        };
    }

    private static string GetAccountTypeLabel(AccountType type)
    {
        return type switch
        {
            AccountType.Cash => "Dinheiro",
            AccountType.Checking => "Conta Corrente",
            AccountType.Savings => "PoupanÃ§a",
            AccountType.CreditCard => "CartÃ£o de crÃ©dito",
            AccountType.Investment => "Investimento",
            _ => type.ToString()
        };
    }

    private int installmentsCount = 1;
    private bool firstInstallmentInCurrentInvoice = true;

    private bool IsSelectedAccountCreditCard()
    {
        if (accountsList is null) return false;
        if (string.IsNullOrWhiteSpace(newRequest.AccountId)) return false;

        var acc = accountsList.FirstOrDefault(a => a.Id == newRequest.AccountId);
        return acc?.Type == AccountType.CreditCard;
    }

    private bool ShouldCreateInstallments() =>
        IsSelectedAccountCreditCard() &&
        newRequest.Type == (int)TransactionType.Expense &&
        installmentsCount > 1;

    private async Task<bool> ConfirmInstallmentStartAsync()
    {
        var startText = firstInstallmentInCurrentInvoice ? "fatura corrente" : "prÃ³xima fatura";
        return await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Confirma cadastrar compra parcelada em {installmentsCount}x, com a 1Âª parcela na {startText}?"

        );
    }

    private async Task CreateInstallmentPurchaseAsync(CreateTransactionRequestDto baseRequest)
    {
        if (installmentsCount <= 1)
        {
            await TransactionService.CreateAsync(baseRequest);
            return;
        }

        // Assumimos que o valor digitado Ã© o TOTAL da compra.
        var installmentAmount = Math.Round(baseRequest.Amount / installmentsCount, 2, MidpointRounding.AwayFromZero);

        // Ajuste simples para manter a soma (caso haja arredondamento):
        // deixamos a Ãºltima parcela como "restante" dentro da recorrÃªncia, mas como a recorrÃªncia
        // no backend nÃ£o tem suporte a "Ãºltima com valor diferente", mantemos o valor fixo.
        // (Se isso for um requisito, precisamos estender a modelagem.)

        var selectedCard = accountsList?.FirstOrDefault(a => a.Id == baseRequest.AccountId);
        if (selectedCard?.Type != AccountType.CreditCard)
        {
            throw new InvalidOperationException("Conta selecionada nÃ£o Ã© um cartÃ£o de crÃ©dito.");
        }

        var closingDay = selectedCard.InvoiceClosingDay.GetValueOrDefault(1);
        if (closingDay < 1 || closingDay > 31) closingDay = 1;

        // Parcela entra na fatura no dia seguinte ao fechamento.
        var postingDay = closingDay + 1;
        if (postingDay > 31) postingDay = 1;

        var purchaseDate = baseRequest.Date.Date;

        // 1) PRIMEIRA PARCELA: Sempre criada IMEDIATAMENTE na data da compra
        var firstReq = new CreateTransactionRequestDto
        {
            AccountId = baseRequest.AccountId,
            CategoryId = baseRequest.CategoryId,
            Type = baseRequest.Type,
            Amount = installmentAmount,
            Date = purchaseDate, // Data da compra (imediata)
            Description = $"{baseRequest.Description} (1/{installmentsCount})",
            Tags = baseRequest.Tags,
            ToAccountId = baseRequest.ToAccountId,
            Status = baseRequest.Status
        };

        await TransactionService.CreateAsync(firstReq);

        // 2) DEMAIS PARCELAS: RecorrÃªncia mensal comeÃ§ando no posting day
        // A lÃ³gica de "fatura corrente" vs "prÃ³xima fatura" se aplica AQUI
        var remaining = installmentsCount - 1;
        if (remaining <= 0)
        {
            return;
        }

        // Calcular data de inÃ­cio da recorrÃªncia (2Âª parcela)
        DateTime secondInstallmentDate;
        
        if (firstInstallmentInCurrentInvoice)
        {
            // Checkbox marcado: prÃ³xima parcela no posting day do mÃªs seguinte ao da compra
            var nextMonth = purchaseDate.AddMonths(1);
            var nextMonthPostingDay = Math.Min(postingDay, DateTime.DaysInMonth(nextMonth.Year, nextMonth.Month));
            secondInstallmentDate = new DateTime(nextMonth.Year, nextMonth.Month, nextMonthPostingDay);
        }
        else
        {
            // Checkbox desmarcado: prÃ³xima parcela pula 2 meses (mÃªs seguinte ao seguinte)
            var twoMonthsAhead = purchaseDate.AddMonths(2);
            var twoMonthsPostingDay = Math.Min(postingDay, DateTime.DaysInMonth(twoMonthsAhead.Year, twoMonthsAhead.Month));
            secondInstallmentDate = new DateTime(twoMonthsAhead.Year, twoMonthsAhead.Month, twoMonthsPostingDay);
        }

        var endDate = secondInstallmentDate.AddMonths(remaining - 1);

        var recurringRequest = new MoneyManager.Application.DTOs.Request.CreateRecurringTransactionRequestDto
        {
            AccountId = baseRequest.AccountId,
            CategoryId = baseRequest.CategoryId,
            Type = baseRequest.Type == (int)TransactionType.Income ? TransactionType.Income : TransactionType.Expense,
            Amount = installmentAmount,
            Description = $"{baseRequest.Description} (Parcela)",
            Frequency = RecurrenceFrequency.Monthly,
            StartDate = secondInstallmentDate,
            EndDate = endDate,
            DayOfMonth = secondInstallmentDate.Day,
            Tags = baseRequest.Tags
        };

        await RecurringTransactionService.CreateAsync(recurringRequest);
    }
}
