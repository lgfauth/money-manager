@page "/transactions"
@using MoneyManager.Web.Services.Localization
@using MoneyManager.Domain.Entities
@using MoneyManager.Domain.Enums
@using MoneyManager.Web.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@attribute [Authorize]
@inject ITransactionService TransactionService
@inject ILocalizationService Localization
@inject IRecurringTransactionService RecurringTransactionService
@inject ILocalizationService Localization
@inject IAccountService AccountService
@inject ILocalizationService Localization
@inject ICategoryService CategoryService
@inject ILocalizationService Localization
@inject IJSRuntime JSRuntime
@inject ILocalizationService Localization

<PageTitle>@Localization.Get("Transactions.PageTitle")</PageTitle>

<BusyOverlay IsBusy="@isBusy" Message="Processando..." />

<div class="container-fluid py-4">
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <h1 class="mb-0">
                <i class="fas fa-exchange-alt text-primary"></i> @Localization.Get("Transactions.Title")
            </h1>
            <button class="btn btn-primary d-none d-md-inline-block" @onclick="ShowAddModal">
                <i class="fas fa-plus"></i> @Localization.Get("Transactions.NewTransaction")
            </button>
        </div>
    </div>
</div>

    <div class="row mb-3">
        <div class="col-12 col-md-4">
            <label class="form-label">Ordenar por</label>
            <select class="form-select" @bind="transactionsSort">
                <option value="date_desc">Data (mais recente)</option>
                <option value="date_asc">Data (mais antiga)</option>
                <option value="category">Categoria</option>
                <option value="amount_desc">Valor (maior)</option>
                <option value="amount_asc">Valor (menor)</option>
            </select>
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">@Localization.Get("Transactions.Period")</label>
            <select class="form-select" @bind="PeriodPreset">
                <option value="current_month">@Localization.Get("Transactions.CurrentMonth")</option>
                <option value="custom">@Localization.Get("Transactions.Custom")</option>
            </select>
        </div>

        <div class="col-6 col-md-2">
            <label class="form-label">De</label>
            <input type="date" class="form-control" @bind="filterStart" disabled="@(periodPreset != "custom")" />
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label">@Localization.Get("Common.To")</label>
            <input type="date" class="form-control" @bind="filterEnd" disabled="@(periodPreset != "custom")" />
        </div>

        <div class="col-12 col-md-4 mt-3 mt-md-0">
            <label class="form-label">Mostrar</label>
            <select class="form-select" @bind="transactionTypeFilter">
                <option value="all">@Localization.Get("Transactions.AllTypes")</option>
                <option value="income">@Localization.Get("Transactions.IncomeOnly")</option>
                <option value="expense">@Localization.Get("Transactions.ExpenseOnly")</option>
                <option value="investment">💼 Investimentos</option>
            </select>
        </div>
    </div>

    @if (showAdd)
    {
        <!-- Modal de Nova Transação -->
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus-circle"></i> 
                            @(string.IsNullOrEmpty(editingTransactionId) ? Localization.Get("Transactions.NewTransaction") : "Editar Transação")
                        </h5>
                        <button type="button" class="btn-close" @onclick="CancelAdd" disabled="@isBusy"></button>
                    </div>
                    <div class="modal-body">
                        @if (!string.IsNullOrEmpty(addError))
                        {
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> @addError
                            </div>
                        }
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Data</label>
                                <input type="date" class="form-control" @bind="newRequest.Date" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" @bind="newRequest.Type">
                                    <option value="0">@Localization.Get("Transactions.Income")</option>
                                    <option value="1">@Localization.Get("Transactions.Expense")</option>
                                    <option value="2">@Localization.Get("Transactions.Transfer")</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Conta @(newRequest.Type == 2 ? "Origem" : "")</label>
                                <select class="form-select" @bind="newRequest.AccountId">
                                    <option value="">-- Selecione uma conta --</option>
                                    @foreach (var a in GetAccountsOrdered(accountsList))
                                    {
                                        <option value="@a.Id">@a.Name (@GetAccountTypeLabel(a.Type))</option>
                                    }
                                </select>
                            </div>
                            
                            @if (newRequest.Type == 2)
                            {
                                <div class="col-md-6">
                                    <label class="form-label">Conta Destino</label>
                                    <select class="form-select" @bind="newRequest.ToAccountId">
                                        <option value="">-- Selecione a conta destino --</option>
                                        @foreach (var a in GetAccountsOrdered(accountsList))
                                        {
                                            if (a.Id != newRequest.AccountId)
                                            {
                                                <option value="@a.Id">@a.Name (@GetAccountTypeLabel(a.Type))</option>
                                            }
                                        }
                                    </select>
                                </div>
                            }
                            else
                            {
                                <div class="col-md-6">
                                    <label class="form-label">@Localization.Get("Transactions.Category")</label>
                                    <select class="form-select" @bind="newRequest.CategoryId">
                                        <option value="">-- Selecione uma categoria --</option>
                                        @if (categoriesList != null)
                                        {
                                            @foreach (var c in categoriesList)
                                            {
                                                <option value="@c.Id">@c.Name</option>
                                            }
                                        }
                                    </select>
                                </div>
                            }
                            
                            <div class="col-12">
                                <label class="form-label">@Localization.Get("Transactions.Description")</label>
                                <input class="form-control" placeholder="Digite a descrição" @bind="newRequest.Description" />
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Valor</label>
                                <MoneyInput @bind-Value="newRequest.Amount" Placeholder="R$ 0,00" />
                            </div>

                            @if (IsSelectedAccountCreditCard() && newRequest.Type == 1)
                            {
                                <div class="col-12">
                                    <div class="alert alert-info py-2">
                                        <div class="row g-3 align-items-end">
                                            <div class="col-md-4">
                                                <label class="form-label mb-1">Parcelamento</label>
                                                <select class="form-select" @bind="installmentsCount">
                                                    @for (var i = 1; i <= 12; i++)
                                                    {
                                                        <option value="@i">@i x</option>
                                                    }
                                                </select>
                                            </div>

                                            <div class="col-md-8">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="firstInCurrent" @bind="firstInstallmentInCurrentInvoice" />
                                                    <label class="form-check-label" for="firstInCurrent">
                                                        Primeira parcela entra na fatura atual
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        @if (installmentsCount > 1)
                                        {
                                            <small class="text-muted d-block mt-2">
                                                <i class="fas fa-info-circle"></i> O valor informado é o total. O sistema lançará a 1ª parcela agora (se marcado) e criará uma recorrência mensal para as demais.
                                            </small>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelAdd" disabled="@isBusy">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        @if (string.IsNullOrEmpty(editingTransactionId))
                        {
                            <button type="button" class="btn btn-primary" @onclick="() => CreateTransaction(false)" disabled="@isBusy">
                                <i class="fas fa-save"></i> Salvar
                            </button>
                            <button type="button" class="btn btn-success" @onclick="() => CreateTransaction(true)" disabled="@isBusy">
                                <i class="fas fa-plus"></i> Salvar e Adicionar Outra
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-primary" @onclick="() => CreateTransaction(false)" disabled="@isBusy">
                                <i class="fas fa-save"></i> Salvar Alterações
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Modal de Confirmação de Parcelamento -->
    @if (showInstallmentConfirmModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-credit-card"></i> Confirmar Compra Parcelada
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => ConfirmInstallment(false)"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-question-circle fa-3x text-primary"></i>
                        </div>
                        <p class="text-center mb-3">
                            @installmentConfirmMessage
                        </p>
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i> <strong>Como funciona:</strong>
                            <ul class="mb-0 mt-2">
                                <li>A 1ª parcela será lançada imediatamente</li>
                                <li>As demais parcelas serão criadas automaticamente como recorrência mensal</li>
                                <li>Você poderá gerenciar as parcelas futuras na aba "Recorrentes"</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => ConfirmInstallment(false)">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="() => ConfirmInstallment(true)">
                            <i class="fas fa-check"></i> Confirmar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3 text-muted">@Localization.Get("Transactions.Loading")</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }
    else if (transactions != null && transactions.Any())
    {
        var viewTransactions = GetTransactionsSorted(ApplyFilters(transactions));
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th><i class="fas fa-calendar"></i> Data</th>
                            <th><i class="fas fa-file-alt"></i> @Localization.Get("Transactions.Description")</th>
                            <th><i class="fas fa-tag"></i> Categoria</th>
                            <th class="text-end"><i class="fas fa-money-bill"></i> Valor</th>
                            <th class="text-center">@Localization.Get("Common.Actions")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var transaction in viewTransactions)
                        {
                            <tr>
                                <td>@transaction.Date.ToString("dd/MM/yyyy")</td>
                                <td>
                                    @GetTransactionTypeIcon(transaction.Type)
                                    @transaction.Description
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">@GetCategoryName(transaction.CategoryId)</span>
                                </td>
                                <td class="text-end fw-bold">
                                    @if (transaction.Type.ToString() == "Income")
                                    {
                                        <span class="text-success">+ R$ @transaction.Amount.ToString("F2")</span>
                                    }
                                    else if (transaction.Type.ToString() == "Transfer")
                                    {
                                        <span class="text-primary">R$ @transaction.Amount.ToString("F2")</span>
                                    }
                                    else if (IsInvestmentTransaction(transaction.Type))
                                    {
                                        <span class="@GetInvestmentTransactionColor(transaction.Type)">@GetInvestmentTransactionSign(transaction.Type) R$ @transaction.Amount.ToString("F2")</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger">- R$ @transaction.Amount.ToString("F2")</span>
                                    }
                                </td>
                                <td class="text-center">
                                <button class="btn btn-sm btn-warning me-2" @onclick="() => BeginEditTransaction(transaction.Id)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteTransaction(transaction.Id)" disabled="@isBusy">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle"></i> @Localization.Get("Transactions.NoTransactions") <a href="#" @onclick="ShowAddModal">Clique aqui para criar uma.</a>
        </div>
    }
</div>

<!-- Botão Flutuante para Mobile -->
<button class="btn btn-primary btn-floating-mobile d-md-none" @onclick="ShowAddModal">
    <i class="fas fa-plus"></i>
</button>

<style>
    .btn-floating-mobile {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        padding: 0;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .btn-floating-mobile:hover,
    .btn-floating-mobile:focus {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    
    .btn-floating-mobile:active {
        transform: scale(0.95);
    }
</style>

@code {
    private IEnumerable<Transaction>? transactions;
    private bool isLoading = true;
    private string? errorMessage;
    private IEnumerable<Account>? accountsList;
    private IEnumerable<Category>? categoriesList;
    private Dictionary<string, string> categoriesDict = new();

    private string transactionsSort = "date_desc";

    private string periodPreset = "current_month";
    private string transactionTypeFilter = "all";
    private DateTime filterStart = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime filterEnd = new(DateTime.Today.Year, DateTime.Today.Month, DateTime.DaysInMonth(DateTime.Today.Year, DateTime.Today.Month));

    private string PeriodPreset
    {
        get => periodPreset;
        set
        {
            if (periodPreset == value) return;

            periodPreset = value;
            if (periodPreset == "current_month")
            {
                ResetFilterToCurrentMonth();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        ResetFilterToCurrentMonth();
        await LoadTransactions();
        accountsList = await AccountService.GetAllAsync();
        categoriesList = await CategoryService.GetAllAsync();
        categoriesDict = categoriesList?.ToDictionary(c => c.Id, c => c.Name) ?? new Dictionary<string, string>();
    }

    private void ResetFilterToCurrentMonth()
    {
        var today = DateTime.Today;
        filterStart = new DateTime(today.Year, today.Month, 1);
        filterEnd = new DateTime(today.Year, today.Month, DateTime.DaysInMonth(today.Year, today.Month));
    }

    private async Task LoadTransactions()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            transactions = await TransactionService.GetAllAsync();
            if (transactions == null || !transactions.Any())
            {
                errorMessage = "Nenhuma transação disponível.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao carregar transações: {ex.Message}";
            Console.WriteLine($"Erro: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowAddModal()
    {
        showAdd = true;
    }

    private bool showAdd;
    private Transaction newTransaction = new Transaction { Date = DateTime.Today };
    private string? addError;
    private CreateTransactionRequestDto newRequest = new CreateTransactionRequestDto { Date = DateTime.Today, Type = (int)TransactionType.Expense };
    private string? editingTransactionId;
    private bool isBusy;

    private async Task BeginEditTransaction(string id)
    {
        try
        {
            var tx = await TransactionService.GetByIdAsync(id);
            if (tx != null)
            {
                // populate request DTO from existing transaction
                newRequest = new CreateTransactionRequestDto
                {
                    AccountId = tx.AccountId,
                    Amount = tx.Amount,
                    CategoryId = tx.CategoryId,
                    Date = tx.Date,
                    Description = tx.Description,
                    Status = (int)tx.Status,
                    Tags = tx.Tags ?? new List<string>(),
                    ToAccountId = tx.ToAccountId,
                    Type = (int)tx.Type
                };

                editingTransactionId = id;
                showAdd = true;
            }
        }
        catch (Exception ex)
        {
            addError = ex.Message;
        }
    }

    private async Task CreateTransaction(bool addAnother = false)
    {
        addError = null;
        if (isBusy) return;
        
        try
        {
            if (string.IsNullOrEmpty(newRequest.AccountId))
            {
                addError = "Selecione uma conta";
                return;
            }

            if (newRequest.Type == 2)
            {
                if (string.IsNullOrEmpty(newRequest.ToAccountId))
                {
                    addError = "Selecione a conta destino";
                    return;
                }

                if (newRequest.ToAccountId == newRequest.AccountId)
                {
                    addError = "A conta destino deve ser diferente da conta origem";
                    return;
                }

                // Categoria não se aplica a Transferências
                newRequest.CategoryId = null;
            }

            // Purchase installment flow (credit card expense)
            // Verificar ANTES de ativar isBusy se precisa confirmar parcelamento
            if (!string.IsNullOrEmpty(editingTransactionId))
            {
                isBusy = true;
                await TransactionService.UpdateAsync(editingTransactionId, newRequest);
                showAdd = false;
                editingTransactionId = null;
            }
            else if (ShouldCreateInstallments())
            {
                // NÃO ativa isBusy aqui - deixa o modal de confirmação aparecer
                var confirmed = await ConfirmInstallmentStartAsync();
                if (!confirmed)
                {
                    return;
                }
                
                // SÓ AGORA ativa o isBusy, após a confirmação
                isBusy = true;
                await CreateInstallmentPurchaseAsync(newRequest);
            }
            else
            {
                isBusy = true;
                await TransactionService.CreateAsync(newRequest);
            }
            
            // Se "Salvar e adicionar outra", limpa o formulário mas mantém aberto
            if (addAnother)
            {
                newRequest = new CreateTransactionRequestDto 
                { 
                    Date = DateTime.Today, 
                    Type = (int)TransactionType.Expense,
                    AccountId = newRequest.AccountId // Mantém a conta selecionada
                };
                installmentsCount = 1;
                firstInstallmentInCurrentInvoice = true;
            }
            else
            {
                showAdd = false;
                newRequest = new CreateTransactionRequestDto { Date = DateTime.Today, Type = (int)TransactionType.Expense };
            }

            await LoadTransactions();
        }
        catch (Exception ex)
        {
            addError = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }

    private void CancelAdd()
    {
        if (isBusy) return;
        showAdd = false;
        newTransaction = new Transaction { Date = DateTime.Today };
        newRequest = new CreateTransactionRequestDto { Date = DateTime.Today, Type = (int)TransactionType.Expense };
        editingTransactionId = null;
        addError = null;
        installmentsCount = 1;
        firstInstallmentInCurrentInvoice = true;
    }

    private async Task DeleteTransaction(string id)
    {
        if (isBusy) return;
        isBusy = true;
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Tem certeza que deseja deletar esta transação?");
            if (!confirmed)
                return;

            await TransactionService.DeleteAsync(id);
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao deletar transação: {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private string GetCategoryName(string? categoryId)
    {
        if (string.IsNullOrEmpty(categoryId))
            return "Sem categoria";

        return categoriesDict.TryGetValue(categoryId, out var name) ? name : "Categoria desconhecida";
    }

    private IEnumerable<Transaction> GetTransactionsSorted(IEnumerable<Transaction> list)
    {
        return transactionsSort switch
        {
            "date_asc" => list.OrderBy(t => t.Date),
            "category" => list.OrderBy(t => GetCategoryName(t.CategoryId)).ThenByDescending(t => t.Date),
            "amount_asc" => list.OrderBy(t => t.Amount),
            "amount_desc" => list.OrderByDescending(t => t.Amount),
            _ => list.OrderByDescending(t => t.Date)
        };
    }

    private IEnumerable<Transaction> ApplyFilters(IEnumerable<Transaction> list)
    {
        var start = filterStart.Date;
        var end = filterEnd.Date;
        if (end < start)
        {
            (start, end) = (end, start);
        }

        var query = list.Where(t => t.Date.Date >= start && t.Date.Date <= end);

        // Separar corretamente transaÇões de despesa das de receita.
        // TransferÃƒÂªncias nÃƒÂ£o entram em entradas/saÃƒÂ­das.
        query = transactionTypeFilter switch
        {
            "income" => query.Where(t => t.Type == TransactionType.Income),
            "expense" => query.Where(t => t.Type == TransactionType.Expense),
            "investment" => query.Where(t => IsInvestmentTransaction(t.Type)),
            _ => query
        };

        return query;
    }

    private bool IsInvestmentTransaction(TransactionType type)
    {
        return type == TransactionType.InvestmentYield ||
               type == TransactionType.InvestmentBuy ||
               type == TransactionType.InvestmentSell;
    }

    private string GetTransactionTypeIcon(TransactionType type)
    {
        return type switch
        {
            TransactionType.InvestmentYield => "💰",
            TransactionType.InvestmentBuy => "🛒",
            TransactionType.InvestmentSell => "💵",
            _ => ""
        };
    }

    private string GetInvestmentTransactionColor(TransactionType type)
    {
        return type switch
        {
            TransactionType.InvestmentYield => "text-success",
            TransactionType.InvestmentBuy => "text-primary",
            TransactionType.InvestmentSell => "text-warning",
            _ => "text-muted"
        };
    }

    private string GetInvestmentTransactionSign(TransactionType type)
    {
        return type switch
        {
            TransactionType.InvestmentYield => "+",
            TransactionType.InvestmentBuy => "-",
            TransactionType.InvestmentSell => "+",
            _ => ""
        };
    }

    private static IEnumerable<Account> GetAccountsOrdered(IEnumerable<Account>? accounts)
    {
        if (accounts is null) return Enumerable.Empty<Account>();

        return accounts
            .OrderBy(a => GetAccountTypeSortKey(a.Type))
            .ThenBy(a => a.Name);
    }

    private static int GetAccountTypeSortKey(AccountType type)
    {
        return type switch
        {
            AccountType.Cash => 0,
            AccountType.Checking => 1,
            AccountType.Savings => 2,
            AccountType.CreditCard => 3,
            AccountType.Investment => 4,
            _ => 99
        };
    }

    private static string GetAccountTypeLabel(AccountType type)
    {
        return type switch
        {
            AccountType.Cash => "Dinheiro",
            AccountType.Checking => "Conta Corrente",
            AccountType.Savings => "Poupança",
            AccountType.CreditCard => "Cartão de Crédito",
            AccountType.Investment => "Investimento",
            _ => type.ToString()
        };
    }

    private int installmentsCount = 1;
    private bool firstInstallmentInCurrentInvoice = true;
    
    // Modal de confirmação de parcelamento
    private bool showInstallmentConfirmModal = false;
    private string installmentConfirmMessage = string.Empty;
    private TaskCompletionSource<bool>? installmentConfirmTcs;

    private bool IsSelectedAccountCreditCard()
    {
        if (accountsList is null) return false;
        if (string.IsNullOrWhiteSpace(newRequest.AccountId)) return false;

        var acc = accountsList.FirstOrDefault(a => a.Id == newRequest.AccountId);
        return acc?.Type == AccountType.CreditCard;
    }

    private bool ShouldCreateInstallments() =>
        IsSelectedAccountCreditCard() &&
        newRequest.Type == (int)TransactionType.Expense &&
        installmentsCount > 1;

    private async Task<bool> ConfirmInstallmentStartAsync()
    {
        var startText = firstInstallmentInCurrentInvoice ? "fatura corrente" : "próxima fatura";
        installmentConfirmMessage = $"Confirma cadastrar compra parcelada em {installmentsCount}x, com a 1ª parcela na {startText}?";
        
        installmentConfirmTcs = new TaskCompletionSource<bool>();
        showInstallmentConfirmModal = true;
        StateHasChanged();
        
        return await installmentConfirmTcs.Task;
    }
    
    private void ConfirmInstallment(bool confirmed)
    {
        showInstallmentConfirmModal = false;
        installmentConfirmTcs?.SetResult(confirmed);
        StateHasChanged();
    }

    private async Task CreateInstallmentPurchaseAsync(CreateTransactionRequestDto baseRequest)
    {
        if (installmentsCount <= 1)
        {
            await TransactionService.CreateAsync(baseRequest);
            return;
        }

        // Assumimos que o valor digitado ÃƒÂ© o TOTAL da compra.
        var installmentAmount = Math.Round(baseRequest.Amount / installmentsCount, 2, MidpointRounding.AwayFromZero);

        // Ajuste simples para manter a soma (caso haja arredondamento):
        // deixamos a ÃƒÂºltima parcela como "restante" dentro da recorrÃƒÂªncia, mas como a recorrÃƒÂªncia
        // no backend nÃƒÂ£o tem suporte a "ÃƒÂºltima com valor diferente", mantemos o valor fixo.
        // (Se isso for um requisito, precisamos estender a modelagem.)

        var selectedCard = accountsList?.FirstOrDefault(a => a.Id == baseRequest.AccountId);
        if (selectedCard?.Type != AccountType.CreditCard)
        {
            throw new InvalidOperationException("Conta selecionada não é um cartão de crédito.");
        }

        var closingDay = selectedCard.InvoiceClosingDay.GetValueOrDefault(1);
        if (closingDay < 1 || closingDay > 31) closingDay = 1;

        // Parcela entra na fatura no dia seguinte ao fechamento.
        var postingDay = closingDay + 1;
        if (postingDay > 31) postingDay = 1;

        var purchaseDate = baseRequest.Date.Date;

        // 1) PRIMEIRA PARCELA: Sempre criada IMEDIATAMENTE na data da compra
        var firstReq = new CreateTransactionRequestDto
        {
            AccountId = baseRequest.AccountId,
            CategoryId = baseRequest.CategoryId,
            Type = baseRequest.Type,
            Amount = installmentAmount,
            Date = purchaseDate, // Data da compra (imediata)
            Description = $"{baseRequest.Description} (1/{installmentsCount})",
            Tags = baseRequest.Tags,
            ToAccountId = baseRequest.ToAccountId,
            Status = baseRequest.Status
        };

        await TransactionService.CreateAsync(firstReq);

        // 2) DEMAIS PARCELAS: RecorrÃƒÂªncia mensal comeÃƒÂ§ando no posting day
        // A lÃƒÂ³gica de "fatura corrente" vs "prÃƒÂ³xima fatura" se aplica AQUI
        var remaining = installmentsCount - 1;
        if (remaining <= 0)
        {
            return;
        }

        // Calcular data de inÃƒÂ­cio da recorrÃƒÂªncia (2Ã‚Âª parcela)
        DateTime secondInstallmentDate;
        
        if (firstInstallmentInCurrentInvoice)
        {
            // Checkbox marcado: prÃƒÂ³xima parcela no posting day do mÃƒÂªs seguinte ao da compra
            var nextMonth = purchaseDate.AddMonths(1);
            var nextMonthPostingDay = Math.Min(postingDay, DateTime.DaysInMonth(nextMonth.Year, nextMonth.Month));
            secondInstallmentDate = new DateTime(nextMonth.Year, nextMonth.Month, nextMonthPostingDay);
        }
        else
        {
            // Checkbox desmarcado: prÃƒÂ³xima parcela pula 2 meses (mÃƒÂªs seguinte ao seguinte)
            var twoMonthsAhead = purchaseDate.AddMonths(2);
            var twoMonthsPostingDay = Math.Min(postingDay, DateTime.DaysInMonth(twoMonthsAhead.Year, twoMonthsAhead.Month));
            secondInstallmentDate = new DateTime(twoMonthsAhead.Year, twoMonthsAhead.Month, twoMonthsPostingDay);
        }

        var endDate = secondInstallmentDate.AddMonths(remaining - 1);

        var recurringRequest = new MoneyManager.Application.DTOs.Request.CreateRecurringTransactionRequestDto
        {
            AccountId = baseRequest.AccountId,
            CategoryId = baseRequest.CategoryId,
            Type = baseRequest.Type == (int)TransactionType.Income ? TransactionType.Income : TransactionType.Expense,
            Amount = installmentAmount,
            Description = $"{baseRequest.Description} (Parcela)",
            Frequency = RecurrenceFrequency.Monthly,
            StartDate = secondInstallmentDate,
            EndDate = endDate,
            DayOfMonth = secondInstallmentDate.Day,
            Tags = baseRequest.Tags
        };

        await RecurringTransactionService.CreateAsync(recurringRequest);
    }
}
