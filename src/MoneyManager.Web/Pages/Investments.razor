@page "/investments"
@using MoneyManager.Application.DTOs.Request
@using MoneyManager.Application.DTOs.Response
@using MoneyManager.Domain.Enums
@using MoneyManager.Web.Services
@using MoneyManager.Web.Services.Localization
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IInvestmentAssetService InvestmentAssetService
@inject IAccountService AccountService
@inject ILocalizationService Localization

@inject NavigationManager Navigation

<PageTitle>@Localization.Get("Investments.PageTitle")</PageTitle>

<BusyOverlay IsBusy="@isBusy" Message="@busyMessage" />

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <h1 class="mb-0">
                    <i class="fas fa-chart-line text-primary"></i> @Localization.Get("Investments.Title")
                </h1>
                <div class="d-flex gap-2">
                    <a href="/investments/reports" class="btn btn-outline-secondary">
                        <i class="fas fa-file-invoice"></i> @Localization.Get("Investments.Reports")
                    </a>
                    <a href="/investments/dashboard" class="btn btn-outline-primary">
                        <i class="fas fa-chart-pie"></i> @Localization.Get("Investments.Dashboard")
                    </a>
                    <button class="btn btn-primary" @onclick="ShowAddModal">
                        <i class="fas fa-plus"></i> @Localization.Get("Investments.AddAsset")
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3 text-muted">@Localization.Get("Investments.Loading")</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }
    else
    {
        <!-- Botão de Atualização de Preços -->
        @if (assets != null && assets.Any(a => !string.IsNullOrWhiteSpace(a.Ticker)))
        {
            <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                <div>
                    <i class="fas fa-sync-alt"></i>
                    <strong>@Localization.Get("Investments.UpdatePrices"):</strong>
                    @Localization.Get("Investments.UpdatePricesInfo")
                    @if (lastPriceUpdate.HasValue)
                    {
                        <span>@Localization.Get("Investments.LastUpdate") @lastPriceUpdate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                    }
                </div>
                <button class="btn btn-sm btn-primary" @onclick="UpdatePricesManually" disabled="@isUpdatingPrices">
                    @if (isUpdatingPrices)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    else
                    {
                        <i class="fas fa-sync-alt me-1"></i>
                    }
                    @Localization.Get("Investments.UpdateNow")
                </button>
            </div>

            @if (!string.IsNullOrEmpty(priceUpdateMessage))
            {
                <div class="alert @(priceUpdateSuccess ? "alert-success" : "alert-warning") alert-dismissible fade show">
                    <i class="fas @(priceUpdateSuccess ? "fa-check-circle" : "fa-exclamation-triangle")"></i>
                    @priceUpdateMessage
                    <button type="button" class="btn-close" @onclick="@(() => priceUpdateMessage = null)"></button>
                </div>
            }
        }

        <!-- Cards de Resumo -->
        @if (summary != null)
        {
            <InvestmentSummaryCard Summary="@summary" />
        }

        @if (HasAssets)
        {
            <!-- Filtros e Ordenação -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Tipo de Ativo -->
                        <div class="col-12 col-md-3">
                            <label class="form-label small text-muted mb-1">@Localization.Get("Investments.AssetType")</label>
                            <select class="form-select form-select-sm" @bind="filterAssetType" @bind:after="OnFilterChanged">
                                <option value="">@Localization.Get("Investments.AllTypes")</option>
                                <option value="@((int)InvestmentAssetType.Stock)">@Localization.Get("Investments.Stock")</option>
                                <option value="@((int)InvestmentAssetType.FixedIncome)">@Localization.Get("Investments.FixedIncome")</option>
                                <option value="@((int)InvestmentAssetType.RealEstate)">@Localization.Get("Investments.RealEstate")</option>
                                <option value="@((int)InvestmentAssetType.Crypto)">@Localization.Get("Investments.Crypto")</option>
                                <option value="@((int)InvestmentAssetType.Fund)">@Localization.Get("Investments.Fund")</option>
                                <option value="@((int)InvestmentAssetType.ETF)">@Localization.Get("Investments.ETF")</option>
                                <option value="@((int)InvestmentAssetType.Other)">@Localization.Get("Investments.Other")</option>
                            </select>
                        </div>

                        <!-- Ordenar por -->
                        <div class="col-12 col-md-3">
                            <label class="form-label small text-muted mb-1">@Localization.Get("Investments.SortBy")</label>
                            <select class="form-select form-select-sm" @bind="sortBy" @bind:after="OnFilterChanged">
                                <option value="name">@Localization.Get("Investments.SortByName")</option>
                                <option value="type">@Localization.Get("Investments.SortByType")</option>
                                <option value="value_desc">@Localization.Get("Investments.SortByValueDesc")</option>
                                <option value="value_asc">@Localization.Get("Investments.SortByValueAsc")</option>
                                <option value="profit_desc">@Localization.Get("Investments.SortByProfitDesc")</option>
                                <option value="profit_asc">@Localization.Get("Investments.SortByProfitAsc")</option>
                                <option value="performance_desc">@Localization.Get("Investments.SortByPerformanceDesc")</option>
                                <option value="performance_asc">@Localization.Get("Investments.SortByPerformanceAsc")</option>
                            </select>
                        </div>

                        <!-- Pesquisar -->
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted mb-1">@Localization.Get("Investments.Search")</label>
                            <input type="text" class="form-control form-control-sm" 
                                   placeholder="@Localization.Get("Investments.SearchPlaceholder")" 
                                   @bind="searchTerm" 
                                   @bind:event="oninput" 
                                   @bind:after="OnFilterChanged" />
                        </div>
                    </div>
                </div>
            </div>

            @if (FilteredAssets.Any())
            {
                <!-- Grid de Ativos -->
                <div class="row g-3">
                    @foreach (var asset in FilteredAssets)
                    {
                        <div class="col-12 col-md-6 col-lg-4">
                            <InvestmentAssetCard 
                                Asset="@asset"
                                OnEdit="@HandleEdit"
                                OnDelete="@HandleDelete"
                                OnBuy="@HandleBuy"
                                OnSell="@HandleSell" />
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info text-center">
                    <i class="fas fa-filter"></i> @Localization.Get("Investments.NoResults")
                </div>
            }
        }
        else
        {
            <!-- Empty State -->
            <div class="card shadow-sm border-0 text-center py-5">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                    <h4>@Localization.Get("Investments.NoAssets")</h4>
                    <p class="text-muted">@Localization.Get("Investments.NoAssetsDescription")</p>
                    <button class="btn btn-primary btn-lg mt-3" @onclick="ShowAddModal">
                        <i class="fas fa-plus"></i> @Localization.Get("Investments.AddFirstAsset")
                    </button>
                </div>
            </div>
        }
    }
</div>

<!-- Modal de Adicionar/Editar Ativo -->
@if (showAddEditModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas @(isEditing ? "fa-edit" : "fa-plus-circle")"></i>
                        @Localization.Get(isEditing ? "Investments.EditAsset" : "Investments.NewAsset")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CancelAddEdit" disabled="@isBusy"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(modalError))
                    {
                        <div class="alert alert-danger alert-dismissible">
                            <i class="fas fa-exclamation-triangle"></i> @modalError
                            <button type="button" class="btn-close" @onclick="@(() => modalError = null)"></button>
                        </div>
                    }

                    <div class="row g-3">
                        @if (!isEditing)
                        {
                            <!-- Conta -->
                            <div class="col-md-6">
                                <label class="form-label">@Localization.Get("Investments.Account") <span class="text-danger">*</span></label>
                                <select class="form-select" @bind="createRequest.AccountId">
                                    <option value="">@Localization.Get("Investments.SelectAccount")</option>
                                    @if (accounts != null)
                                    {
                                        @foreach (var account in accounts.Where(a => a.Type == AccountType.Investment))
                                        {
                                            <option value="@account.Id">@account.Name</option>
                                        }
                                    }
                                </select>
                            </div>

                            <!-- Tipo de Ativo -->
                            <div class="col-md-6">
                                <label class="form-label">@Localization.Get("Investments.AssetType") <span class="text-danger">*</span></label>
                                <select class="form-select" @bind="createRequest.AssetType">
                                    <option value="@InvestmentAssetType.Stock">@Localization.Get("Investments.Stock")</option>
                                    <option value="@InvestmentAssetType.FixedIncome">@Localization.Get("Investments.FixedIncome")</option>
                                    <option value="@InvestmentAssetType.RealEstate">@Localization.Get("Investments.RealEstate")</option>
                                    <option value="@InvestmentAssetType.Crypto">@Localization.Get("Investments.Crypto")</option>
                                    <option value="@InvestmentAssetType.Fund">@Localization.Get("Investments.Fund")</option>
                                    <option value="@InvestmentAssetType.ETF">@Localization.Get("Investments.ETF")</option>
                                    <option value="@InvestmentAssetType.Other">@Localization.Get("Investments.Other")</option>
                                </select>
                            </div>
                        }

                        <!-- Nome -->
                        <div class="col-md-6">
                            <label class="form-label">@Localization.Get("Investments.Name") <span class="text-danger">*</span></label>
                            @if (isEditing)
                            {
                                <input type="text" class="form-control" @bind="currentName" placeholder="@Localization.Get("Investments.NamePlaceholder")" />
                            }
                            else
                            {
                                <input type="text" class="form-control" @bind="createRequest.Name" placeholder="@Localization.Get("Investments.NamePlaceholder")" />
                            }
                        </div>

                        <!-- Ticker -->
                        <div class="col-md-6">
                            <label class="form-label">@Localization.Get("Investments.Ticker")</label>
                            @if (isEditing)
                            {
                                <input type="text" class="form-control" @bind="currentTicker" placeholder="@Localization.Get("Investments.TickerPlaceholder")" />
                            }
                            else
                            {
                                <input type="text" class="form-control" @bind="createRequest.Ticker" placeholder="@Localization.Get("Investments.TickerPlaceholder")" />
                            }
                        </div>

                        @if (!isEditing)
                        {
                            <!-- Quantidade Inicial -->
                            <div class="col-md-4">
                                <label class="form-label">@Localization.Get("Investments.InitialQuantity")</label>
                                <input type="number" class="form-control" 
                                       @bind="createRequest.InitialQuantity" 
                                       step="0.01" 
                                       min="0" />
                            </div>

                            <!-- Preço Inicial -->
                            <div class="col-md-4">
                                <label class="form-label">@Localization.Get("Investments.InitialPrice")</label>
                                <MoneyInput @bind-Value="createRequest.InitialPrice" Placeholder="R$ 0,00" />
                            </div>

                            <!-- Taxas -->
                            <div class="col-md-4">
                                <label class="form-label">@Localization.Get("Investments.InitialFees")</label>
                                <MoneyInput @bind-Value="createRequest.InitialFees" Placeholder="R$ 0,00" />
                            </div>

                            @if (createRequest.InitialQuantity > 0 && createRequest.InitialPrice > 0)
                            {
                                <div class="col-12">
                                    <div class="alert alert-info mb-0">
                                        <strong>@Localization.Get("Investments.TotalToInvest")</strong> 
                                        R$ @((createRequest.InitialQuantity * createRequest.InitialPrice + createRequest.InitialFees).ToString("N2"))
                                    </div>
                                </div>
                            }
                        }

                        <!-- Notas -->
                        <div class="col-12">
                            <label class="form-label">@Localization.Get("Investments.Notes")</label>
                            @if (isEditing)
                            {
                                <textarea class="form-control" @bind="currentNotes" rows="3" placeholder="@Localization.Get("Investments.NotesPlaceholder")"></textarea>
                            }
                            else
                            {
                                <textarea class="form-control" @bind="createRequest.Notes" rows="3" placeholder="@Localization.Get("Investments.NotesPlaceholder")"></textarea>
                            }
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelAddEdit" disabled="@isBusy">
                        <i class="fas fa-times"></i> @Localization.Get("Investments.Cancel")
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="SaveAsset" disabled="@isBusy">
                        @if (isBusy)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        else
                        {
                            <i class="fas fa-save"></i>
                        }
                        @Localization.Get(isEditing ? "Investments.Save" : "Investments.Add")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal de Confirmação de Exclusão -->
@if (showDeleteModal && assetToDelete != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-trash"></i> @Localization.Get("Investments.ConfirmDelete")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelDelete" disabled="@isBusy"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                    </div>
                    <p class="text-center">
                        @Localization.Get("Investments.DeleteQuestion", assetToDelete.Name)
                    </p>
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i>
                        <strong>@Localization.Get("Common.Warning"):</strong> @Localization.Get("Investments.DeleteWarning")
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete" disabled="@isBusy">
                        <i class="fas fa-times"></i> @Localization.Get("Investments.Cancel")
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@isBusy">
                        @if (isBusy)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        else
                        {
                            <i class="fas fa-trash"></i>
                        }
                        @Localization.Get("Investments.DeleteConfirm")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
// Data
private List<InvestmentAssetResponseDto>? assets;
private InvestmentSummaryResponseDto? summary;
private IEnumerable<Domain.Entities.Account>? accounts;

// Loading States
private bool isLoading = true;
private bool isBusy = false;
private string busyMessage = "";
private string? errorMessage;
private string? modalError;

// Filtros
private string filterAssetType = "";
private string sortBy = "name";
private string searchTerm = "";

// Modais
private bool showAddEditModal = false;
private bool showDeleteModal = false;
private bool isEditing = false;
private string? editingAssetId;
private InvestmentAssetResponseDto? assetToDelete;

// Requests
private CreateInvestmentAssetRequestDto createRequest = new() { AssetType = InvestmentAssetType.Stock };
private UpdateInvestmentAssetRequestDto updateRequest = new();
    
// Separate properties for editing
private string currentName = "";
private string? currentTicker = "";
private string? currentNotes = "";

// Price Update
private bool isUpdatingPrices = false;
private string? priceUpdateMessage;
private bool priceUpdateSuccess = false;
private DateTime? lastPriceUpdate;

// Computed Properties
private bool HasAssets => assets != null && assets.Any();

    private List<InvestmentAssetResponseDto> FilteredAssets
    {
        get
        {
            if (assets == null) return new List<InvestmentAssetResponseDto>();

            var filtered = assets.AsEnumerable();

            if (!string.IsNullOrEmpty(filterAssetType) && int.TryParse(filterAssetType, out var typeValue))
            {
                var assetType = (InvestmentAssetType)typeValue;
                filtered = filtered.Where(a => a.AssetType == assetType);
            }

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                var search = searchTerm.ToLower();
                filtered = filtered.Where(a =>
                    a.Name.ToLower().Contains(search) ||
                    (!string.IsNullOrEmpty(a.Ticker) && a.Ticker.ToLower().Contains(search))
                );
            }

            filtered = sortBy switch
            {
                "type" => filtered.OrderBy(a => a.AssetType).ThenBy(a => a.Name),
                "value_desc" => filtered.OrderByDescending(a => a.CurrentValue),
                "value_asc" => filtered.OrderBy(a => a.CurrentValue),
                "profit_desc" => filtered.OrderByDescending(a => a.ProfitLoss),
                "profit_asc" => filtered.OrderBy(a => a.ProfitLoss),
                "performance_desc" => filtered.OrderByDescending(a => a.ProfitLossPercentage),
                "performance_asc" => filtered.OrderBy(a => a.ProfitLossPercentage),
                _ => filtered.OrderBy(a => a.Name)
            };

            return filtered.ToList();
        }
    }

protected override async Task OnInitializedAsync()
{
    await LoadData();
}

private void OnFilterChanged()
{
    // Force re-render when filters change
    StateHasChanged();
}

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var assetsTask = InvestmentAssetService.GetAllAsync();
            var summaryTask = InvestmentAssetService.GetSummaryAsync();
            var accountsTask = AccountService.GetAllAsync();

            await Task.WhenAll(assetsTask, summaryTask, accountsTask);

            assets = (await assetsTask)?.ToList();
            summary = await summaryTask;
            accounts = await accountsTask;

            // Atualizar last price update
            if (assets != null && assets.Any())
            {
                lastPriceUpdate = assets
                    .Where(a => a.LastPriceUpdate.HasValue)
                    .OrderByDescending(a => a.LastPriceUpdate)
                    .Select(a => a.LastPriceUpdate)
                    .FirstOrDefault();
            }
        }
        catch (Exception ex)
        {
            errorMessage = Localization.Get("Investments.ErrorLoading", ex.Message);
            Console.WriteLine($"[Investments] Erro: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UpdatePricesManually()
    {
        if (isUpdatingPrices) return;

        isUpdatingPrices = true;
        priceUpdateMessage = null;
        priceUpdateSuccess = false;

        try
        {
            Console.WriteLine("[Investments] Iniciando atualização manual de preços...");

            var response = await InvestmentAssetService.UpdatePricesAsync();

            if (response != null)
            {
                priceUpdateSuccess = true;
                priceUpdateMessage = Localization.Get("Investments.UpdateSuccess", response.Updated, response.Skipped);
                
                // Recarregar dados
                await LoadData();
            }
            else
            {
                priceUpdateSuccess = false;
                priceUpdateMessage = Localization.Get("Investments.UpdateError");
            }
        }
        catch (Exception ex)
        {
            priceUpdateSuccess = false;
            priceUpdateMessage = Localization.Get("Investments.ErrorSaving", ex.Message);
            Console.WriteLine($"[Investments] Erro ao atualizar preços: {ex}");
        }
        finally
        {
            isUpdatingPrices = false;
        }
    }

    private void ShowAddModal()
    {
        isEditing = false;
        editingAssetId = null;
        createRequest = new CreateInvestmentAssetRequestDto { AssetType = InvestmentAssetType.Stock };
        modalError = null;
        showAddEditModal = true;
    }

    private void HandleEdit(InvestmentAssetResponseDto asset)
    {
        isEditing = true;
        editingAssetId = asset.Id;
        currentName = asset.Name;
        currentTicker = asset.Ticker;
        currentNotes = asset.Notes;
        modalError = null;
        showAddEditModal = true;
    }

    private void CancelAddEdit()
    {
        showAddEditModal = false;
        isEditing = false;
        editingAssetId = null;
        modalError = null;
    }

    private async Task SaveAsset()
    {
        if (isBusy) return;

        modalError = null;
        isBusy = true;
        busyMessage = Localization.Get(isEditing ? "Investments.Saving" : "Investments.Creating");

        try
        {
            if (isEditing && !string.IsNullOrEmpty(editingAssetId))
            {
                if (string.IsNullOrWhiteSpace(currentName))
                {
                    modalError = Localization.Get("Investments.ErrorNameRequired");
                    return;
                }

                updateRequest = new UpdateInvestmentAssetRequestDto
                {
                    Name = currentName,
                    Ticker = currentTicker,
                    Notes = currentNotes
                };

                await InvestmentAssetService.UpdateAsync(editingAssetId, updateRequest);
            }
            else
            {
                if (string.IsNullOrEmpty(createRequest.AccountId))
                {
                    modalError = Localization.Get("Investments.ErrorAccountRequired");
                    return;
                }

                if (string.IsNullOrWhiteSpace(createRequest.Name))
                {
                    modalError = Localization.Get("Investments.ErrorNameRequired");
                    return;
                }

                await InvestmentAssetService.CreateAsync(createRequest);
            }

            showAddEditModal = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            modalError = Localization.Get("Investments.ErrorSaving", ex.Message);
            Console.WriteLine($"[Investments] Erro ao salvar: {ex}");
        }
        finally
        {
            isBusy = false;
            busyMessage = "";
        }
    }

    private void HandleDelete(InvestmentAssetResponseDto asset)
    {
        assetToDelete = asset;
        showDeleteModal = true;
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
        assetToDelete = null;
    }

    private async Task ConfirmDelete()
    {
        if (isBusy || assetToDelete == null) return;

        isBusy = true;
        busyMessage = Localization.Get("Investments.Deleting");

        try
        {
            await InvestmentAssetService.DeleteAsync(assetToDelete.Id);
            showDeleteModal = false;
            assetToDelete = null;
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = Localization.Get("Investments.ErrorDeleting", ex.Message);
            Console.WriteLine($"[Investments] Erro ao excluir: {ex}");
        }
        finally
        {
            isBusy = false;
            busyMessage = "";
        }
    }

    private void HandleBuy(InvestmentAssetResponseDto asset)
    {
        Console.WriteLine($"[Investments] Comprar ativo: {asset.Name}");
    }

    private void HandleSell(InvestmentAssetResponseDto asset)
    {
        Console.WriteLine($"[Investments] Vender ativo: {asset.Name}");
    }
}
