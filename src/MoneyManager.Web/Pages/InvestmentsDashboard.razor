@page "/investments/dashboard"
@using MoneyManager.Application.DTOs.Response
@using MoneyManager.Domain.Enums
@using MoneyManager.Web.Services
@using MoneyManager.Web.Services.Localization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@attribute [Authorize]
@inject IInvestmentAssetService InvestmentAssetService
@inject IInvestmentTransactionService InvestmentTransactionService
@inject ILocalizationService Localization
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>@Localization.Get("InvestmentsDashboard.PageTitle")</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <h1 class="mb-0">
                    <i class="fas fa-chart-pie text-primary"></i> @Localization.Get("InvestmentsDashboard.Title")
                </h1>
                <div class="d-flex gap-2">
                    <a href="/investments/reports" class="btn btn-outline-secondary">
                        <i class="fas fa-file-invoice"></i> @Localization.Get("InvestmentsDashboard.Reports")
                    </a>
                    <a href="/investments" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> @Localization.Get("InvestmentsDashboard.BackToAssets")
                    </a>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3 text-muted">@Localization.Get("InvestmentsDashboard.Loading")</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }
    else if (summary != null)
    {
        <!-- A. Cards de M�tricas (Topo) -->
        <div class="row g-3 mb-4">
            <!-- Total Investido -->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-primary bg-opacity-10 rounded p-3 me-3">
                                <i class="fas fa-wallet text-primary fa-2x"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">@Localization.Get("InvestmentsDashboard.TotalInvested")</small>
                                <h4 class="mb-0 fw-bold">R$ @summary.TotalInvested.ToString("N2")</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Valor Atual -->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-info bg-opacity-10 rounded p-3 me-3">
                                <i class="fas fa-chart-line text-info fa-2x"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">@Localization.Get("InvestmentsDashboard.CurrentValue")</small>
                                <h4 class="mb-0 fw-bold">R$ @summary.CurrentValue.ToString("N2")</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lucro/Preju�zo -->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="@GetProfitLossCardClass() rounded p-3 me-3">
                                <i class="fas @GetProfitLossIcon() @GetProfitLossTextClass() fa-2x"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">@Localization.Get("InvestmentsDashboard.ProfitLoss")</small>
                                <h4 class="mb-0 fw-bold @GetProfitLossTextClass()">R$ @summary.TotalProfitLoss.ToString("N2")</h4>
                                <small class="@GetProfitLossTextClass()">@summary.TotalProfitLossPercentage.ToString("N2")%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rentabilidade -->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-warning bg-opacity-10 rounded p-3 me-3">
                                <i class="fas fa-percentage text-warning fa-2x"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">@Localization.Get("InvestmentsDashboard.TotalReturn")</small>
                                <h4 class="mb-0 fw-bold @GetProfitLossTextClass()">@summary.TotalProfitLossPercentage.ToString("N2")%</h4>
                                @if (summary.TotalYields > 0)
                                {
                                    <small class="text-success">+R$ @summary.TotalYields.ToString("N2") @Localization.Get("Investments.TotalYields")</small>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- B. Gr�ficos -->
        <div class="row g-4 mb-4">
            <!-- Gr�fico 1: Diversifica��o por Tipo -->
            <div class="col-12 col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-pie text-primary"></i> Diversifica��o por Tipo de Ativo
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="chartDiversificationType" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gr�fico 2: Top 10 Ativos -->
            <div class="col-12 col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar text-primary"></i> @Localization.Get("InvestmentsDashboard.Top10Assets")
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTopAssets" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gr�fico 3: Evolu��o Patrimonial -->
            <div class="col-12 col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line text-primary"></i> Evolu��o Patrimonial
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn @(evolutionPeriod == "1M" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SetEvolutionPeriod("1M"))">@Localization.Get("InvestmentsDashboard.Period1M")</button>
                            <button type="button" class="btn @(evolutionPeriod == "3M" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SetEvolutionPeriod("3M"))">@Localization.Get("InvestmentsDashboard.Period3M")</button>
                            <button type="button" class="btn @(evolutionPeriod == "6M" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SetEvolutionPeriod("6M"))">@Localization.Get("InvestmentsDashboard.Period6M")</button>
                            <button type="button" class="btn @(evolutionPeriod == "1Y" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SetEvolutionPeriod("1Y"))">@Localization.Get("InvestmentsDashboard.Period1Y")</button>
                            <button type="button" class="btn @(evolutionPeriod == "ALL" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SetEvolutionPeriod("ALL"))">@Localization.Get("InvestmentsDashboard.PeriodAll")</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="chartEvolution" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gr�fico 4: Rendimentos Mensais -->
            <div class="col-12 col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0">
                            <i class="fas fa-coins text-primary"></i> Rendimentos Mensais (�ltimos 12 meses)
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="chartMonthlyYields" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- C. Tabelas de An�lise -->
        <div class="row g-4">
            <!-- @Localization.Get("InvestmentsDashboard.TopPerformers") -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-trophy"></i> @Localization.Get("InvestmentsDashboard.TopPerformers")
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        @if (summary.TopPerformers != null && summary.TopPerformers.Any())
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var asset in summary.TopPerformers.Take(5))
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-bold">@asset.AssetName</div>
                                                <small class="text-muted">
                                                    <AssetTypeIcon AssetType="@asset.AssetType" />
                                                    @GetAssetTypeName(asset.AssetType)
                                                </small>
                                            </div>
                                            <span class="badge bg-success fs-6">
                                                +@asset.ProfitLossPercentage.ToString("N2")%
                                            </span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="p-3 text-center text-muted">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p class="mb-0">Sem dados dispon�veis</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- @Localization.Get("InvestmentsDashboard.WorstPerformers") -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line"></i> @Localization.Get("InvestmentsDashboard.WorstPerformers")
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        @if (summary.WorstPerformers != null && summary.WorstPerformers.Any())
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var asset in summary.WorstPerformers.Take(5))
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-bold">@asset.AssetName</div>
                                                <small class="text-muted">
                                                    <AssetTypeIcon AssetType="@asset.AssetType" />
                                                    @GetAssetTypeName(asset.AssetType)
                                                </small>
                                            </div>
                                            <span class="badge bg-danger fs-6">
                                                @asset.ProfitLossPercentage.ToString("N2")%
                                            </span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="p-3 text-center text-muted">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p class="mb-0">Sem dados dispon�veis</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Transa��es Recentes -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-history"></i> Transa��es Recentes
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        @if (recentTransactions != null && recentTransactions.Any())
                        {
                            <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                                @foreach (var tx in recentTransactions.Take(20))
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="fw-bold small">@tx.AssetName</div>
                                                <small class="text-muted">
                                                    @GetTransactionTypeIcon(tx.TransactionType)
                                                    @GetTransactionTypeName(tx.TransactionType)
                                                    @if (tx.Quantity > 0)
                                                    {
                                                        <span> - @tx.Quantity.ToString("N2")</span>
                                                    }
                                                </small>
                                                <div><small class="text-muted">@tx.Date.ToString("dd/MM/yyyy")</small></div>
                                            </div>
                                            <span class="badge @GetTransactionBadgeClass(tx.TransactionType)">
                                                R$ @tx.TotalAmount.ToString("N2")
                                            </span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="p-3 text-center text-muted">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p class="mb-0">Sem transa��es</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Empty State -->
        <div class="card shadow-sm border-0 text-center py-5">
            <div class="card-body">
                <i class="fas fa-chart-pie fa-4x text-muted mb-3"></i>
                <h4>@Localization.Get("InvestmentsDashboard.EmptyTitle")</h4>
                <p class="text-muted">Adicione investimentos para visualizar an�lises e gr�ficos</p>
                <a href="/investments" class="btn btn-primary mt-3">
                    <i class="fas fa-plus"></i> @Localization.Get("InvestmentsDashboard.AddInvestments")
                </a>
            </div>
        </div>
    }
</div>

@code {
    // Data
    private InvestmentSummaryResponseDto? summary;
    private List<InvestmentAssetResponseDto>? assets;
    private List<InvestmentTransactionResponseDto>? recentTransactions;

    // Loading States
    private bool isLoading = true;
    private string? errorMessage;

    // Chart periods
    private string evolutionPeriod = "6M";
    
    // Flag para controlar renderiza��o dos gr�ficos
    private bool chartsRendered = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Renderizar gr�ficos quando os dados estiverem dispon�veis e ainda n�o foram renderizados
        if (!isLoading && !chartsRendered && summary != null && assets != null)
        {
            chartsRendered = true;
            Console.WriteLine("[InvestmentsDashboard] Condi��es atendidas, iniciando renderiza��o dos gr�ficos...");
            
            // Aguardar um pouco para garantir que o DOM est� pronto
            await Task.Delay(100);
            
            // Verificar se chartInterop est� dispon�vel
            try
            {
                var isAvailable = await JSRuntime.InvokeAsync<bool>("eval", "typeof chartInterop !== 'undefined'");
                Console.WriteLine($"[InvestmentsDashboard] chartInterop dispon�vel: {isAvailable}");
                
                if (isAvailable)
                {
                    await RenderCharts();
                }
                else
                {
                    Console.WriteLine("[InvestmentsDashboard] ERRO: chartInterop n�o est� dispon�vel!");
                    chartsRendered = false; // Permitir nova tentativa
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[InvestmentsDashboard] Erro ao verificar chartInterop: {ex.Message}");
                chartsRendered = false; // Permitir nova tentativa
            }
        }
        else
        {
            Console.WriteLine($"[InvestmentsDashboard] OnAfterRenderAsync - firstRender: {firstRender}, isLoading: {isLoading}, chartsRendered: {chartsRendered}, summary: {summary != null}, assets: {assets != null}");
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            Console.WriteLine("[InvestmentsDashboard] Iniciando carregamento de dados...");
            
            var summaryTask = InvestmentAssetService.GetSummaryAsync();
            var assetsTask = InvestmentAssetService.GetAllAsync();
            var transactionsTask = InvestmentTransactionService.GetAllAsync();

            await Task.WhenAll(summaryTask, assetsTask, transactionsTask);

            summary = await summaryTask;
            assets = (await assetsTask)?.ToList();
            recentTransactions = (await transactionsTask)?
                .OrderByDescending(t => t.Date)
                .ToList();
                
            Console.WriteLine($"[InvestmentsDashboard] Summary carregado: TotalInvested={summary?.TotalInvested}");
            Console.WriteLine($"[InvestmentsDashboard] Assets carregados: {assets?.Count ?? 0}");
            Console.WriteLine($"[InvestmentsDashboard] Transactions carregadas: {recentTransactions?.Count ?? 0}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao carregar dashboard: {ex.Message}";
            Console.WriteLine($"[InvestmentsDashboard] Erro: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RenderCharts()
    {
        try
        {
            Console.WriteLine("[InvestmentsDashboard] ===== INICIANDO RENDERIZA��O =====");
            Console.WriteLine($"[InvestmentsDashboard] Summary: {summary != null}");
            Console.WriteLine($"[InvestmentsDashboard] Assets: {assets != null} ({assets?.Count ?? 0})");
            Console.WriteLine($"[InvestmentsDashboard] AssetsByType: {summary?.AssetsByType?.Count() ?? 0}");
            
            if (summary == null || assets == null)
            {
                Console.WriteLine("[InvestmentsDashboard] Dados insuficientes para renderizar");
                return;
            }

            // Gr�fico 1: Diversifica��o por Tipo (Pizza)
            try
            {
                if (summary.AssetsByType != null && summary.AssetsByType.Any())
                {
                    Console.WriteLine("[InvestmentsDashboard] === Gr�fico 1: Diversifica��o por Tipo ===");
                    
                    var labels = summary.AssetsByType.Select(dto => GetAssetTypeName(dto.AssetType)).ToArray();
                    var data = summary.AssetsByType.Select(dto => (double)dto.CurrentValue).ToArray();
                    var colors = summary.AssetsByType.Select((dto, i) => GetChartColorByIndex(i)).ToArray();

                    Console.WriteLine($"[InvestmentsDashboard] Labels: {string.Join(", ", labels)}");
                    Console.WriteLine($"[InvestmentsDashboard] Data: {string.Join(", ", data)}");
                    Console.WriteLine($"[InvestmentsDashboard] Chamando chartInterop.createPieChart...");

                    await JSRuntime.InvokeVoidAsync("chartInterop.createPieChart", "chartDiversificationType", labels, data, colors);
                    Console.WriteLine("[InvestmentsDashboard] ? Gr�fico 1 renderizado");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[InvestmentsDashboard] ? Erro no Gr�fico 1: {ex.Message}");
            }

            // Gr�fico 2: Top 10 Ativos (Barras)
            try
            {
                if (assets.Any())
                {
                    Console.WriteLine("[InvestmentsDashboard] === Gr�fico 2: Top 10 Ativos ===");
                    
                    var topAssets = assets.OrderByDescending(a => a.CurrentValue).Take(10).ToList();
                    var labels = topAssets.Select(a => a.Name).ToArray();
                    var data = topAssets.Select(a => (double)a.CurrentValue).ToArray();
                    var colors = topAssets.Select((_, i) => GetChartColorByIndex(i)).ToArray();

                    Console.WriteLine($"[InvestmentsDashboard] Labels: {string.Join(", ", labels)}");
                    Console.WriteLine($"[InvestmentsDashboard] Data: {string.Join(", ", data)}");
                    Console.WriteLine($"[InvestmentsDashboard] Chamando chartInterop.createBarChart...");

                    await JSRuntime.InvokeVoidAsync("chartInterop.createBarChart", "chartTopAssets", labels, data, colors);
                    Console.WriteLine("[InvestmentsDashboard] ? Gr�fico 2 renderizado");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[InvestmentsDashboard] ? Erro no Gr�fico 2: {ex.Message}");
            }

            // Gr�fico 3: Evolu��o (Linha)
            try
            {
                Console.WriteLine("[InvestmentsDashboard] === Gr�fico 3: Evolu��o ===");
                await RenderEvolutionChart();
                Console.WriteLine("[InvestmentsDashboard] ? Gr�fico 3 renderizado");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[InvestmentsDashboard] ? Erro no Gr�fico 3: {ex.Message}");
            }

            // Gr�fico 4: Rendimentos Mensais (Barras)
            try
            {
                Console.WriteLine("[InvestmentsDashboard] === Gr�fico 4: Rendimentos ===");
                await RenderMonthlyYieldsChart();
                Console.WriteLine("[InvestmentsDashboard] ? Gr�fico 4 renderizado");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[InvestmentsDashboard] ? Erro no Gr�fico 4: {ex.Message}");
            }
            
            Console.WriteLine("[InvestmentsDashboard] ===== RENDERIZA��O CONCLU�DA =====");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[InvestmentsDashboard] ??? ERRO GERAL: {ex.Message}");
            Console.WriteLine($"[InvestmentsDashboard] Stack: {ex.StackTrace}");
        }
    }

    private async Task RenderEvolutionChart()
    {
        try
        {
            Console.WriteLine("[InvestmentsDashboard] Gerando dados mock para evolu��o patrimonial...");
            
            // Mock data - substituir por dados reais do hist�rico
            var labels = Enumerable.Range(0, 12)
                .Select(i =>
                {
                    var date = DateTime.Today.AddMonths(-11 + i);
                    return date.ToString("MMM/yy");
                })
                .ToArray();

            var incomeData = Enumerable.Range(0, 12)
                .Select(i => (double)(summary?.CurrentValue ?? 0) * (1 + new Random(i).NextDouble() * 0.1 - 0.05))
                .ToArray();

            var expensesData = Enumerable.Range(0, 12)
                .Select(i => (double)(summary?.TotalInvested ?? 0) * (1 + new Random(i + 100).NextDouble() * 0.1 - 0.05))
                .ToArray();

            Console.WriteLine($"[InvestmentsDashboard] Dados de evolu��o gerados: {labels.Length} pontos");
            
            await JSRuntime.InvokeVoidAsync("chartInterop.createLineChart", "chartEvolution", labels, new { income = incomeData, expenses = expensesData });
            Console.WriteLine("[InvestmentsDashboard] Gr�fico de evolu��o renderizado");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[InvestmentsDashboard] Erro ao renderizar evolu��o: {ex.Message}");
        }
    }

    private async Task RenderMonthlyYieldsChart()
    {
        try
        {
            Console.WriteLine("[InvestmentsDashboard] Gerando dados mock para rendimentos mensais...");
            
            // Mock data - substituir por dados reais de rendimentos
            var labels = Enumerable.Range(0, 12)
                .Select(i =>
                {
                    var date = DateTime.Today.AddMonths(-11 + i);
                    return date.ToString("MMM/yy");
                })
                .ToArray();

            var data = Enumerable.Range(0, 12)
                .Select(i => (double)(new Random(i).Next(100, 500)))
                .ToArray();

            var colors = labels.Select((_, i) => "rgba(75, 192, 192, 0.7)").ToArray();

            Console.WriteLine($"[InvestmentsDashboard] Dados de rendimentos gerados: {labels.Length} pontos");
            await JSRuntime.InvokeVoidAsync("chartInterop.createBarChart", "chartMonthlyYields", labels, data, colors);
            Console.WriteLine("[InvestmentsDashboard] Gr�fico de rendimentos mensais renderizado");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[InvestmentsDashboard] Erro ao renderizar rendimentos: {ex.Message}");
        }
    }

    private string GetChartColorByIndex(int index)
    {
        var colors = new[]
        {
            "rgba(54, 162, 235, 0.7)",
            "rgba(255, 159, 64, 0.7)",
            "rgba(153, 102, 255, 0.7)",
            "rgba(255, 205, 86, 0.7)",
            "rgba(75, 192, 192, 0.7)",
            "rgba(255, 99, 132, 0.7)",
            "rgba(102, 126, 234, 0.7)",
            "rgba(118, 75, 162, 0.7)",
            "rgba(255, 107, 107, 0.7)",
            "rgba(78, 205, 196, 0.7)"
        };
        return colors[index % colors.Length];
    }

    private async Task SetEvolutionPeriod(string period)
    {
        evolutionPeriod = period;
        await RenderEvolutionChart();
    }

    // Helper Methods
    private string GetProfitLossCardClass() => summary?.TotalProfitLoss >= 0 ? "bg-success bg-opacity-10" : "bg-danger bg-opacity-10";
    private string GetProfitLossTextClass() => summary?.TotalProfitLoss >= 0 ? "text-success" : "text-danger";
    private string GetProfitLossIcon() => summary?.TotalProfitLoss >= 0 ? "fa-arrow-trend-up" : "fa-arrow-trend-down";

    private string GetAssetTypeName(InvestmentAssetType type)
    {
        return type switch
        {
            InvestmentAssetType.Stock => "A��es",
            InvestmentAssetType.FixedIncome => "Renda Fixa",
            InvestmentAssetType.RealEstate => "FIIs",
            InvestmentAssetType.Crypto => "Cripto",
            InvestmentAssetType.Fund => "Fundos",
            InvestmentAssetType.ETF => "ETFs",
            _ => "Outros"
        };
    }

    private string GetTransactionTypeName(InvestmentTransactionType type)
    {
        return type switch
        {
            InvestmentTransactionType.Buy => "Compra",
            InvestmentTransactionType.Sell => "Venda",
            InvestmentTransactionType.Dividend => "Dividendo",
            InvestmentTransactionType.Interest => "Juros",
            InvestmentTransactionType.YieldPayment => "Rendimento",
            InvestmentTransactionType.MarketAdjustment => "Ajuste",
            InvestmentTransactionType.Fee => "Taxa",
            _ => type.ToString()
        };
    }

    private string GetTransactionTypeIcon(InvestmentTransactionType type)
    {
        return type switch
        {
            InvestmentTransactionType.Buy => "??",
            InvestmentTransactionType.Sell => "??",
            InvestmentTransactionType.Dividend => "??",
            InvestmentTransactionType.Interest => "??",
            InvestmentTransactionType.YieldPayment => "??",
            InvestmentTransactionType.MarketAdjustment => "??",
            InvestmentTransactionType.Fee => "??",
            _ => "??"
        };
    }

    private string GetTransactionBadgeClass(InvestmentTransactionType type)
    {
        return type switch
        {
            InvestmentTransactionType.Buy => "bg-primary",
            InvestmentTransactionType.Sell => "bg-warning text-dark",
            InvestmentTransactionType.Dividend or InvestmentTransactionType.Interest or InvestmentTransactionType.YieldPayment => "bg-success",
            InvestmentTransactionType.Fee => "bg-danger",
            _ => "bg-secondary"
        };
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("chartInterop.destroyAllCharts");
        }
        catch
        {
            // ignore
        }
    }
}

